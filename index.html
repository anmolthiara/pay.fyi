<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>pay.fyi</title>
    <link rel="manifest" href="/manifest.webmanifest">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <!-- Select2 for searchable dropdowns -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;1,100;1,200;1,300;1,400;1,500;1,600;1,700&family=Instrument+Sans:ital,wght@0,400..700;1,400..700&family=Syne:wght@400..800&display=swap"
        rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'mono': ['"IBM Plex Mono"', 'monospace'],
                        'syne': ['"Syne"', 'sans-serif'],
                        'instrument': ['"Instrument Sans"', 'sans-serif']
                    }
                }
            }
        }
    </script>
    <style>
        /* Dark mode variables */
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #e5fbf8;
            --bg-card: #ffffff;
            --text-primary: #1f2937;
            --text-secondary: #57534e;
            --border-color: #e5e7eb;
            --border-color-focus: #3b82f6;
        }

        body.dark-mode {
            --bg-primary: #0a0a0a;
            --bg-secondary: #1a1a1a;
            --bg-card: #171717;
            --text-primary: #e5e5e5;
            --text-secondary: #a3a3a3;
            --border-color: #404040;
            --border-color-focus: #8feeff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "IBM Plex Mono", monospace;
            background: var(--bg-primary);
            color: var(--text-primary);
            padding: 20px;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px;
        }

        h1,
        h2 {
            color: var(--text-primary);
        }

        h1 {
            margin-bottom: 30px;
            font-size: 2rem;
        }

        h2 {
            margin-bottom: 20px;
            font-size: 1.25rem;
        }

        .inputs-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .inputs-grid-four {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .input-section {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 8px;
            border: 2px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
            margin-bottom: 15px;
        }

        .section-header h2 {
            margin: 0;
            font-size: 1.1rem;
            color: var(--text-primary);
        }

        .collapse-icon {
            font-size: 1.2rem;
            transition: transform 0.3s ease;
            color: var(--text-primary);
        }

        .collapse-icon.collapsed {
            transform: rotate(-90deg);
        }

        .collapsible-content {
            overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.3s ease;
        }

        .collapsible-content.collapsed {
            max-height: 0 !important;
            opacity: 0;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text-primary);
        }

        /* Custom autocomplete styling */
        .autocomplete-wrapper {
            position: relative;
            width: 100%;
        }

        .autocomplete-items {
            position: absolute;
            border: 2px solid var(--border-color);
            border-top: none;
            z-index: 99;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 250px;
            overflow-y: auto;
            background: var(--bg-card);
            border-radius: 0 0 6px 6px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .autocomplete-items div {
            padding: 10px;
            cursor: pointer;
            background-color: var(--bg-card);
            color: var(--text-primary);
            border-bottom: 1px solid var(--border-color);
        }

        .autocomplete-items div:hover {
            background-color: var(--bg-secondary);
        }

        .autocomplete-active {
            background-color: var(--bg-secondary) !important;
        }

        .input-group input[type="number"],
        .input-group input[type="text"],
        .input-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            font-size: 0.95rem;
            font-family: inherit;
            background: var(--bg-card);
            color: var(--text-primary);
            transition: border-color 0.3s ease, background-color 0.3s ease;
        }

        .input-group input[type="number"]:focus,
        .input-group input[type="text"]:focus,
        .input-group select:focus {
            outline: none;
            border-color: var(--border-color-focus);
        }

        .input-group input[type="number"]:disabled,
        .input-group select:disabled {
            background: var(--bg-secondary);
            cursor: not-allowed;
            opacity: 0.6;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 8px;
            border: 2px solid var(--border-color);
            text-align: center;
            transition: all 0.3s ease;
        }

        .summary-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .summary-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .summary-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .summary-card:nth-child(1) .summary-value {
            color: #3b82f6;
        }

        .summary-card:nth-child(2) .summary-value {
            color: #10b981;
        }

        .summary-card:nth-child(3) .summary-value {
            color: #8b5cf6;
        }

        .summary-card:nth-child(4) .summary-value {
            color: #f59e0b;
        }

        .chart-container {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 8px;
            border: 2px solid var(--border-color);
            margin-bottom: 30px;
            transition: all 0.3s ease;
        }

        .table-container {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 8px;
            border: 2px solid var(--border-color);
            margin-bottom: 30px;
            overflow-x: auto;
            transition: all 0.3s ease;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        table thead {
            background: var(--bg-secondary);
        }

        table th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: var(--text-primary);
            border-bottom: 2px solid var(--border-color);
        }

        table td {
            padding: 12px;
            color: var(--text-primary);
            border-bottom: 1px solid var(--border-color);
        }

        table tbody tr:hover {
            background: var(--bg-secondary);
        }

        .note {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #ff630f;
            font-size: 0.9rem;
            line-height: 1.6;
            color: var(--text-primary);
            margin-bottom: 30px;
        }

        /* Select2 Dark Mode Overrides */
        body.dark-mode .select2-container--default .select2-selection--single {
            background-color: var(--bg-card) !important;
            border: 2px solid var(--border-color) !important;
            color: var(--text-primary) !important;
        }

        body.dark-mode .select2-container--default .select2-selection--single .select2-selection__rendered {
            color: #e5e5e5 !important;
        }

        body.dark-mode .select2-container--default .select2-selection--single .select2-selection__arrow b {
            border-color: #e5e5e5 transparent transparent transparent !important;
        }

        body.dark-mode .select2-container--default.select2-container--open .select2-selection--single .select2-selection__arrow b {
            border-color: transparent transparent #e5e5e5 transparent !important;
        }

        body.dark-mode .select2-dropdown {
            background-color: var(--bg-card) !important;
            border: 2px solid var(--border-color) !important;
        }

        body.dark-mode .select2-container--default .select2-results__option {
            background-color: var(--bg-card) !important;
            color: #e5e5e5 !important;
        }

        body.dark-mode .select2-container--default .select2-results__option--highlighted[aria-selected] {
            background-color: var(--bg-secondary) !important;
            color: #8feeff !important;
        }

        body.dark-mode .select2-container--default .select2-results__option[aria-selected=true] {
            background-color: var(--bg-secondary) !important;
            color: #8feeff !important;
        }

        body.dark-mode .select2-search--dropdown .select2-search__field {
            background-color: var(--bg-card) !important;
            border: 2px solid var(--border-color) !important;
            color: #e5e5e5 !important;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Onboarding Styles */
        .onboarding-step {
            min-height: 60vh;
            padding: 40px 20px;
        }

        .comp-option {
            cursor: pointer;
            display: block;
        }

        .comp-option input[type="radio"] {
            display: none;
        }

        .comp-option-content {
            padding: 20px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-secondary);
            transition: all 0.3s ease;
            height: 100%;
        }

        .comp-option:hover .comp-option-content {
            border-color: #8feeff;
            background: var(--bg-card);
        }

        .comp-option input[type="radio"]:checked+.comp-option-content {
            border-color: #8feeff;
            background: var(--bg-card);
            box-shadow: 0 0 0 3px rgba(143, 238, 255, 0.1);
        }

        @media (max-width: 768px) {

            .inputs-grid,
            .inputs-grid-four {
                grid-template-columns: 1fr;
            }

            .summary-grid {
                grid-template-columns: 1fr;
            }

            .container {
                padding: 15px;
            }

            body {
                padding: 10px;
            }

            h1 {
                font-size: 1.5rem;
            }

            table {
                font-size: 0.8rem;
            }

            table th,
            table td {
                padding: 8px;
            }

            /* Onboarding step titles */
            .onboarding-step h2 {
                font-size: 1.3rem !important;
            }

            .onboarding-step p {
                font-size: 0.9rem !important;
            }

            .onboarding-step {
                padding: 20px 10px !important;
            }

            /* Compensation option cards */
            .comp-option {
                min-width: 100% !important;
            }

            .comp-option-content {
                padding: 15px !important;
            }

            .comp-option-content>div:first-child {
                font-size: 0.95rem !important;
            }

            .comp-option-content>div:last-child {
                font-size: 0.8rem !important;
            }

            /* Header buttons */
            #startOverBtn,
            #darkModeToggle {
                padding: 6px 12px !important;
                font-size: 0.8rem !important;
            }

            /* Onboarding buttons */
            .onboarding-step button {
                padding: 12px !important;
                font-size: 0.95rem !important;
            }

            /* Profile banner */
            #profileBanner {
                padding: 15px !important;
            }

            #profileBanner h3 {
                font-size: 1rem !important;
            }

            #profileBanner p {
                font-size: 0.8rem !important;
            }

            #profileBadge {
                padding: 6px 12px !important;
                font-size: 0.75rem !important;
            }

            #profileBanner button {
                padding: 6px 12px !important;
                font-size: 0.75rem !important;
            }

            /* AI Analysis button */
            #analyzeBtn {
                padding: 12px !important;
                font-size: 0.9rem !important;
            }
        }
    </style>
</head>

<body class="font-mono antialiased p-5 min-h-screen">
    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
            <div>
                <h1 class="font-instrument font-bold" style="margin: 0; font-size: 24px;">pay.fyi</h1>
                <p class="font-mono" style="margin: 5px 0 0 0; font-size: 0.9rem; color: #ff630f !important;">By Anmol
                    Thiara</p>
            </div>
            <div style="display: flex; gap: 10px;">
                <button id="startOverBtn" onclick="resetOnboarding()"
                    style="display: none; padding: 8px 16px; background: var(--bg-secondary); color: var(--text-primary); border: 2px solid var(--border-color); border-radius: 6px; cursor: pointer; font-size: 0.9rem; font-weight: 500;">
                    ‚öôÔ∏è Start Over
                </button>
                <button id="darkModeToggle" onclick="toggleDarkMode()"
                    style="padding: 8px 16px; background: #333231; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem; font-weight: 500;">
                    <span id="darkModeIcon">üåô</span>
                </button>
                <button onclick="resetCalculator()"
                    style="padding: 8px 16px; background: #ff630f; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem; font-weight: 500;">
                    Reset Values
                </button>
            </div>
        </div>

        <!-- Onboarding Flow -->
        <div id="onboardingFlow" style="display: block;">
            <!-- Step 1: Personal Info -->
            <div id="onboardingStep1" class="onboarding-step">
                <div style="max-width: 800px; margin: 0 auto;">
                    <h2 style="font-size: 1.8rem; margin-bottom: 10px; text-align: center;">Welcome to pay.fyi üëã</h2>
                    <p style="text-align: center; color: var(--text-primary); margin-bottom: 40px; font-size: 1.1rem;">
                        Let's get started by learning about your role
                    </p>

                    <div class="inputs-grid" style="margin-bottom: 30px;">
                        <div class="input-group">
                            <label for="onboardRole">Role/Title *</label>
                            <div class="autocomplete-wrapper">
                                <input type="text" id="onboardRole" placeholder="e.g., Senior Software Engineer"
                                    autocomplete="off" required>
                            </div>
                        </div>
                        <div class="input-group">
                            <label for="onboardLocation">Location *</label>
                            <div class="autocomplete-wrapper">
                                <input type="text" id="onboardLocation" placeholder="e.g., San Francisco, CA"
                                    autocomplete="off" required>
                            </div>
                        </div>
                        <div class="input-group">
                            <label for="onboardYearsExp">Years of Experience *</label>
                            <input type="number" id="onboardYearsExp" min="0" max="50" placeholder="e.g., 5" required>
                        </div>
                        <div class="input-group">
                            <label for="onboardIndustry">Industry *</label>
                            <div class="autocomplete-wrapper">
                                <input type="text" id="onboardIndustry" placeholder="e.g., Technology"
                                    autocomplete="off" required>
                            </div>
                        </div>
                        <div class="input-group">
                            <label for="onboardCompany">Company (Optional)</label>
                            <div class="autocomplete-wrapper">
                                <input type="text" id="onboardCompany" placeholder="e.g., Google" autocomplete="off">
                            </div>
                        </div>
                    </div>

                    <button onclick="goToStep2()"
                        style="width: 100%; padding: 15px; background: #8feeff; color: #0a0a0a; border: none; border-radius: 6px; cursor: pointer; font-size: 1.1rem; font-weight: 600; transition: all 0.3s ease; margin-top: 20px;">
                        Continue ‚Üí
                    </button>
                </div>
            </div>

            <!-- Step 2: Compensation Structure -->
            <div id="onboardingStep2" class="onboarding-step" style="display: none;">
                <div style="max-width: 800px; margin: 0 auto;">
                    <h2 style="font-size: 1.8rem; margin-bottom: 10px; text-align: center;">Your Compensation Structure
                        üí∞</h2>
                    <p
                        style="text-align: center; color: var(--text-secondary); margin-bottom: 40px; font-size: 1.1rem;">
                        Tell us about your compensation package
                    </p>

                    <!-- Cash Structure -->
                    <div style="margin-bottom: 40px;">
                        <h3 style="font-size: 1.3rem; margin-bottom: 20px;">1. Cash Compensation</h3>
                        <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                            <label class="comp-option" style="flex: 1; min-width: 250px;">
                                <input type="radio" name="cashType" value="straight" checked>
                                <div class="comp-option-content">
                                    <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 5px;">üíµ Straight
                                        Salary</div>
                                    <div style="font-size: 0.85rem; color: var(--text-secondary);">Fixed annual salary
                                        only</div>
                                </div>
                            </label>
                            <label class="comp-option" style="flex: 1; min-width: 250px;">
                                <input type="radio" name="cashType" value="commission">
                                <div class="comp-option-content">
                                    <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 5px;">üìà Salary +
                                        Commission (OTE)</div>
                                    <div style="font-size: 0.85rem; color: var(--text-secondary);">Base + variable
                                        performance pay</div>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- Equity Structure -->
                    <div style="margin-bottom: 40px;">
                        <h3 style="font-size: 1.3rem; margin-bottom: 20px;">2. Equity Compensation</h3>
                        <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                            <label class="comp-option" style="flex: 1; min-width: 200px;">
                                <input type="radio" name="equityType" value="none" checked>
                                <div class="comp-option-content">
                                    <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 5px;">‚ùå No Equity
                                    </div>
                                    <div style="font-size: 0.85rem; color: var(--text-secondary);">Cash only</div>
                                </div>
                            </label>
                            <label class="comp-option" style="flex: 1; min-width: 200px;">
                                <input type="radio" name="equityType" value="rsu">
                                <div class="comp-option-content">
                                    <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 5px;">üìä RSUs</div>
                                    <div style="font-size: 0.85rem; color: var(--text-secondary);">Restricted Stock
                                        Units</div>
                                </div>
                            </label>
                            <label class="comp-option" style="flex: 1; min-width: 200px;">
                                <input type="radio" name="equityType" value="iso">
                                <div class="comp-option-content">
                                    <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 5px;">üéØ ISOs</div>
                                    <div style="font-size: 0.85rem; color: var(--text-secondary);">Stock Options</div>
                                </div>
                            </label>
                        </div>
                    </div>

                    <div style="display: flex; gap: 15px;">
                        <button onclick="goToStep1()"
                            style="flex: 1; padding: 15px; background: var(--bg-secondary); color: var(--text-primary); border: 2px solid var(--border-color); border-radius: 6px; cursor: pointer; font-size: 1.1rem; font-weight: 600;">
                            ‚Üê Back
                        </button>
                        <button onclick="completeOnboarding()"
                            style="flex: 2; padding: 15px; background: #8feeff; color: #0a0a0a; border: none; border-radius: 6px; cursor: pointer; font-size: 1.1rem; font-weight: 600; transition: all 0.3s ease;">
                            Get Started üöÄ
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Calculator Section (Hidden Initially) -->
        <div id="calculatorSection" style="display: none;">

            <!-- User Profile Banner -->
            <div id="profileBanner"
                style="background: var(--bg-secondary); border: 2px solid var(--border-color); border-radius: 8px; padding: 20px; margin-bottom: 30px;">
                <div
                    style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                    <div>
                        <h3 style="margin: 0 0 8px 0; font-size: 1.2rem;" id="profileRole">Loading...</h3>
                        <p style="margin: 0; color: var(--text-secondary); font-size: 0.9rem;" id="profileDetails">
                            Loading...</p>
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <span id="profileBadge"
                            style="padding: 8px 16px; background: #8feeff; color: #0a0a0a; border-radius: 6px; font-size: 0.85rem; font-weight: 600;">üíµ
                            Cash Only</span>
                        <button onclick="editCompStructure()"
                            style="padding: 8px 16px; background: var(--bg-card); color: var(--text-primary); border: 2px solid var(--border-color); border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 600; transition: all 0.3s ease;">
                            ‚úèÔ∏è Edit
                        </button>
                    </div>
                </div>
            </div>

            <!-- RSU Calculator Content -->
            <div id="rsuCalculator">
                <div class="inputs-grid-four">
                    <!-- Cash Compensation -->
                    <div class="input-section">
                        <div class="section-header" onclick="toggleSection('cashCompSection')">
                            <h2>Cash Compensation</h2>
                            <span class="collapse-icon" id="cashCompIcon">‚ñº</span>
                        </div>
                        <div class="collapsible-content" id="cashCompSection">
                            <p style="font-size: 0.85rem; color: #57534e; margin-bottom: 15px;">Auto-applies 3% annual
                                raise
                                each year</p>

                            <!-- Straight Salary Mode (default) -->
                            <div id="straightSalaryMode">
                                <div class="input-group">
                                    <label for="baseSalary">Starting Base Salary ($)</label>
                                    <input type="number" id="baseSalary" min="0" step="1000" placeholder="0">
                                </div>

                                <div class="input-group">
                                    <label style="display: flex; align-items: center; cursor: pointer;">
                                        <input type="checkbox" id="enableAnnualRaise" checked
                                            style="width: auto; margin-right: 10px; cursor: pointer;">
                                        <span>Apply 3% annual raise</span>
                                    </label>
                                </div>

                                <div class="input-group">
                                    <label for="bonusPercent">Annual Bonus (%)</label>
                                    <input type="number" id="bonusPercent" min="0" max="100" step="0.5" placeholder="0">
                                    <p style="font-size: 0.75rem; color: #57534e; margin-top: 5px;">Applied to base
                                        salary each
                                        year
                                    </p>
                                </div>
                            </div>

                            <!-- Commission/OTE Mode -->
                            <div id="commissionMode" style="display: none;">
                                <!-- Toggle between OTE and Base+Variable -->
                                <div class="input-group" style="margin-bottom: 20px;">
                                    <label style="display: flex; align-items: center; cursor: pointer;">
                                        <input type="checkbox" id="oteInputMode"
                                            style="width: auto; margin-right: 10px; cursor: pointer;">
                                        <span>Enter OTE (On-Target Earnings) instead of Base + Variable</span>
                                    </label>
                                </div>

                                <!-- Base + Variable Mode (default) -->
                                <div id="baseVariableInputs">
                                    <div class="input-group">
                                        <label for="commissionBase">Base Salary ($)</label>
                                        <input type="number" id="commissionBase" min="0" step="1000" placeholder="0">
                                    </div>

                                    <div class="input-group">
                                        <label for="targetVariable">Target Variable/Commission ($)</label>
                                        <input type="number" id="targetVariable" min="0" step="1000" placeholder="0">
                                        <p style="font-size: 0.75rem; color: #57534e; margin-top: 5px;">
                                            Target commission at 100% attainment
                                        </p>
                                    </div>

                                    <div
                                        style="padding: 12px; background: var(--bg-secondary); border-radius: 6px; margin-top: 10px;">
                                        <p style="font-size: 0.85rem; color: var(--text-secondary); margin: 0;">
                                            <strong>OTE (On-Target Earnings):</strong> <span
                                                id="calculatedOTE">$0</span>
                                        </p>
                                    </div>
                                </div>

                                <!-- OTE Input Mode -->
                                <div id="oteInputs" style="display: none;">
                                    <div class="input-group">
                                        <label for="oteAmount">OTE (On-Target Earnings) ($)</label>
                                        <input type="number" id="oteAmount" min="0" step="1000" placeholder="0">
                                    </div>

                                    <div class="input-group">
                                        <label for="baseSplit">Base Salary % of OTE</label>
                                        <input type="number" id="baseSplit" min="0" max="100" step="1" placeholder="70"
                                            value="70">
                                        <p style="font-size: 0.75rem; color: #57534e; margin-top: 5px;">
                                            Common splits: 70/30, 75/25, 80/20, 60/40
                                        </p>
                                    </div>

                                    <div
                                        style="padding: 12px; background: var(--bg-secondary); border-radius: 6px; margin-top: 10px;">
                                        <p style="font-size: 0.85rem; color: var(--text-secondary); margin: 0 0 5px 0;">
                                            <strong>Base Salary:</strong> <span id="calculatedBase">$0</span>
                                        </p>
                                        <p style="font-size: 0.85rem; color: var(--text-secondary); margin: 0;">
                                            <strong>Target Variable:</strong> <span id="calculatedVariable">$0</span>
                                        </p>
                                    </div>
                                </div>

                                <div class="input-group" style="margin-top: 15px;">
                                    <label style="display: flex; align-items: center; cursor: pointer;">
                                        <input type="checkbox" id="enableAnnualRaiseComm" checked
                                            style="width: auto; margin-right: 10px; cursor: pointer;">
                                        <span>Apply 3% annual raise to base salary</span>
                                    </label>
                                </div>
                            </div>

                            <!-- Sign-On Bonus (both modes) -->
                            <div class="input-group">
                                <label for="signOnBonus">Sign-On Bonus ($)</label>
                                <input type="number" id="signOnBonus" min="0" step="1000" placeholder="0">
                                <p style="font-size: 0.75rem; color: #57534e; margin-top: 5px;">One-time payment in Year
                                    1
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- RSU Grants -->
                    <div class="input-section" id="rsuGrantsInputSection">
                        <div class="section-header" onclick="toggleSection('rsuGrantsSection')">
                            <h2>RSU Grants</h2>
                            <span class="collapse-icon" id="rsuGrantsIcon">‚ñº</span>
                        </div>
                        <div class="collapsible-content" id="rsuGrantsSection">
                            <div class="input-group">
                                <label for="initialGrant">Initial Grant (RSUs)</label>
                                <input type="number" id="initialGrant" min="0" step="10" placeholder="0">
                            </div>

                            <div class="input-group">
                                <label for="vestingSchedule">Vesting Schedule</label>
                                <select id="vestingSchedule"
                                    style="width: 100%; padding: 10px; border: 2px solid var(--border-color); border-radius: 6px; font-size: 0.95rem; background: var(--bg-card); color: var(--text-primary);">
                                    <option value="front">Front-loaded (40/30/20/10)</option>
                                    <option value="even">Even (25/25/25/25)</option>
                                </select>
                            </div>

                            <div style="border-top: 1px solid #d1d5db; margin: 15px 0; padding-top: 15px;">
                                <div class="input-group" style="margin-bottom: 15px;">
                                    <label style="display: flex; align-items: center; cursor: pointer;">
                                        <input type="checkbox" id="enableRefreshers"
                                            style="width: auto; margin-right: 10px; cursor: pointer;">
                                        <span style="font-weight: 500;">Include Annual Refreshers</span>
                                    </label>
                                </div>
                            </div>

                            <div id="refreshersInputs" style="display: none;">
                                <div class="input-group">
                                    <label for="refresherYear2">Year 2 Grant (RSUs)</label>
                                    <input type="number" id="refresherYear2" min="0" step="10" placeholder="0">
                                </div>

                                <div class="input-group">
                                    <label for="refresherYear3">Year 3 Grant (RSUs)</label>
                                    <input type="number" id="refresherYear3" min="0" step="10" placeholder="0">
                                </div>

                                <div class="input-group">
                                    <label for="refresherYear4">Year 4 Grant (RSUs)</label>
                                    <input type="number" id="refresherYear4" min="0" step="10" placeholder="0">
                                </div>

                                <div class="input-group">
                                    <label for="refresherVesting">Refresher Vesting % (per year)</label>
                                    <input type="number" id="refresherVesting" min="0" max="100" step="1" value="25">
                                    <p style="font-size: 0.75rem; color: #57534e; margin-top: 5px;">% that vests in year
                                        granted
                                        (typical: 25% for 4-yr vest)</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Stock Prices -->
                    <div class="input-section" id="stockPriceInputSection">
                        <div class="section-header" onclick="toggleSection('stockPriceSection')">
                            <h2>Stock Price per Year</h2>
                            <span class="collapse-icon" id="stockPriceIcon">‚ñº</span>
                        </div>
                        <div class="collapsible-content" id="stockPriceSection">
                            <div class="input-group">
                                <label for="stockYear1">Year 1 Stock Price ($)</label>
                                <input type="number" id="stockYear1" min="0" step="1" placeholder="0">
                            </div>

                            <div class="input-group">
                                <label for="stockGrowth">Annual Stock Growth (%)</label>
                                <input type="number" id="stockGrowth" min="-100" max="500" step="1" placeholder="0">
                                <p style="font-size: 0.75rem; color: #57534e; margin-top: 5px;">Auto-calculates Years
                                    2-4
                                    prices
                                    (0 = no growth)</p>
                            </div>

                            <div style="border-top: 1px solid #d1d5db; margin: 15px 0; padding-top: 15px;">
                                <p style="font-size: 0.85rem; color: #57534e; margin-bottom: 10px; font-weight: 500;">Or
                                    manually set each year:</p>
                            </div>

                            <div class="input-group">
                                <label for="stockYear2">Year 2 Stock Price ($)</label>
                                <input type="number" id="stockYear2" min="0" step="1" placeholder="0">
                            </div>

                            <div class="input-group">
                                <label for="stockYear3">Year 3 Stock Price ($)</label>
                                <input type="number" id="stockYear3" min="0" step="1" placeholder="0">
                            </div>

                            <div class="input-group">
                                <label for="stockYear4">Year 4 Stock Price ($)</label>
                                <input type="number" id="stockYear4" min="0" step="1" placeholder="0">
                            </div>
                        </div>
                    </div>

                    <!-- Tax Withholding -->
                    <div class="input-section">
                        <div class="section-header" onclick="toggleSection('taxWithholdingSection')">
                            <h2>Tax Withholding</h2>
                            <span class="collapse-icon" id="taxWithholdingIcon">‚ñº</span>
                        </div>
                        <div class="collapsible-content" id="taxWithholdingSection">
                            <p style="font-size: 0.85rem; color: #57534e; margin-bottom: 15px;">Optional: Calculate
                                after-tax
                                compensation using progressive federal tax brackets</p>

                            <div class="input-group">
                                <label for="enableTax">
                                    <input type="checkbox" id="enableTax" style="width: auto; margin-right: 8px;">
                                    Apply tax withholding
                                </label>
                            </div>

                            <div class="input-group">
                                <label for="filingStatus">Filing Status</label>
                                <select id="filingStatus"
                                    style="width: 100%; padding: 10px; border: 2px solid var(--border-color); border-radius: 6px; font-size: 0.95rem; background: var(--bg-card); color: var(--text-primary);">
                                    <option value="single">Single</option>
                                    <option value="married">Married Filing Jointly</option>
                                    <option value="head">Head of Household</option>
                                </select>
                                <p style="font-size: 0.75rem; color: #57534e; margin-top: 5px;">Automatically applies
                                    2026
                                    standard deduction and progressive brackets</p>
                            </div>

                            <div class="input-group">
                                <label for="stateTaxRate">State Tax Rate (%)</label>
                                <input type="number" id="stateTaxRate" min="0" max="20" step="0.5" placeholder="0">
                                <p style="font-size: 0.75rem; color: #57534e; margin-top: 5px;">CA: ~9-13%, NY: ~4-11%,
                                    TX/FL:
                                    0%</p>
                            </div>

                            <div class="input-group">
                                <label for="ficaTaxRate">FICA Tax (%)</label>
                                <input type="number" id="ficaTaxRate" min="0" max="20" step="0.01" value="7.65">
                                <p style="font-size: 0.75rem; color: #57534e; margin-top: 5px;">Social Security (6.2%) +
                                    Medicare (1.45%) = 7.65%</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Summary Stats -->
                <div class="summary-grid">
                    <div class="summary-card">
                        <div class="summary-label">Year 1 Total</div>
                        <div class="summary-value" id="year1Total" onclick="copyToClipboard(this)"
                            style="cursor: pointer;" title="Click to copy">$0</div>
                        <div class="summary-label" style="font-size: 0.75rem; margin-top: 5px;" id="year1TotalAfterTax">
                        </div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-label">Year 4 Total</div>
                        <div class="summary-value" id="year4Total" onclick="copyToClipboard(this)"
                            style="cursor: pointer;" title="Click to copy">$0</div>
                        <div class="summary-label" style="font-size: 0.75rem; margin-top: 5px;" id="year4TotalAfterTax">
                        </div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-label">4-Year Total</div>
                        <div class="summary-value" id="fourYearTotal" onclick="copyToClipboard(this)"
                            style="cursor: pointer;" title="Click to copy">$0</div>
                        <div class="summary-label" style="font-size: 0.75rem; margin-top: 5px;"
                            id="fourYearTotalAfterTax">
                        </div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-label">Average Annual</div>
                        <div class="summary-value" id="avgAnnual" onclick="copyToClipboard(this)"
                            style="cursor: pointer;" title="Click to copy">$0</div>
                        <div class="summary-label" style="font-size: 0.75rem; margin-top: 5px;" id="avgAnnualAfterTax">
                        </div>
                    </div>
                </div>

                <!-- Stacked Bar Chart -->
                <div class="chart-container">
                    <div class="section-header" onclick="toggleSection('stackedChartSection')">
                        <h2>Compensation Breakdown by Year</h2>
                        <span class="collapse-icon" id="stackedChartIcon">‚ñº</span>
                    </div>
                    <div class="collapsible-content" id="stackedChartSection">
                        <canvas id="stackedChart" onclick="copyChartToClipboard('stackedChart')"
                            style="cursor: pointer;" title="Click to copy chart as image"></canvas>
                    </div>
                </div>

                <!-- Detailed Table -->
                <div class="chart-container">
                    <div class="section-header" onclick="toggleSection('detailedTableSection')">
                        <h2>Detailed Breakdown</h2>
                        <span class="collapse-icon" id="detailedTableIcon">‚ñº</span>
                    </div>
                    <div class="collapsible-content" id="detailedTableSection">
                        <div style="overflow-x: auto; -webkit-overflow-scrolling: touch;">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Year</th>
                                        <th class="text-right">Base Salary</th>
                                        <th class="text-right">Target Variable</th>
                                        <th class="text-right">Sign-On</th>
                                        <th class="text-right">Initial RSUs</th>
                                        <th class="text-right">Refresher RSUs</th>
                                        <th class="text-right">Stock Price</th>
                                        <th class="text-right">Stock Value</th>
                                        <th class="text-right"><strong>Total Comp</strong></th>
                                        <th class="text-right" id="afterTaxHeader" style="display: none;"><strong>After
                                                Tax</strong></th>
                                    </tr>
                                </thead>
                                <tbody id="tableBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <!-- AI Compensation Comparison -->
                <div class="chart-container" style="margin-top: 30px;">
                    <h2 style="margin-bottom: 20px;">ü§ñ AI Compensation Analysis</h2>
                    <p style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 20px;">
                        Get AI-powered insights comparing your compensation package to industry standards.
                    </p>

                    <!-- Show profile summary instead of input fields -->
                    <div
                        style="padding: 20px; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 20px; border: 2px solid var(--border-color);">
                        <div
                            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div>
                                <p
                                    style="font-size: 0.75rem; color: var(--text-secondary); margin: 0 0 5px 0; text-transform: uppercase; letter-spacing: 0.5px;">
                                    Role</p>
                                <p style="font-size: 0.95rem; font-weight: 600; margin: 0;" id="aiSummaryRole">-</p>
                            </div>
                            <div>
                                <p
                                    style="font-size: 0.75rem; color: var(--text-secondary); margin: 0 0 5px 0; text-transform: uppercase; letter-spacing: 0.5px;">
                                    Location</p>
                                <p style="font-size: 0.95rem; font-weight: 600; margin: 0;" id="aiSummaryLocation">-</p>
                            </div>
                            <div>
                                <p
                                    style="font-size: 0.75rem; color: var(--text-secondary); margin: 0 0 5px 0; text-transform: uppercase; letter-spacing: 0.5px;">
                                    Experience</p>
                                <p style="font-size: 0.95rem; font-weight: 600; margin: 0;" id="aiSummaryYears">-</p>
                            </div>
                            <div>
                                <p
                                    style="font-size: 0.75rem; color: var(--text-secondary); margin: 0 0 5px 0; text-transform: uppercase; letter-spacing: 0.5px;">
                                    Industry</p>
                                <p style="font-size: 0.95rem; font-weight: 600; margin: 0;" id="aiSummaryIndustry">-</p>
                            </div>
                            <div>
                                <p
                                    style="font-size: 0.75rem; color: var(--text-secondary); margin: 0 0 5px 0; text-transform: uppercase; letter-spacing: 0.5px;">
                                    Company</p>
                                <p style="font-size: 0.95rem; font-weight: 600; margin: 0;" id="aiSummaryCompany">-</p>
                            </div>
                        </div>
                    </div>

                    <button onclick="analyzeCompensation()" id="analyzeBtn"
                        style="width: 100%; padding: 15px; background: #8feeff; color: #0a0a0a; border: none; border-radius: 6px; cursor: pointer; font-size: 1rem; font-weight: 600; transition: all 0.3s ease;">
                        Analyze My Compensation üöÄ
                    </button>

                    <div id="aiAnalysisResult"
                        style="margin-top: 20px; padding: 25px; background: var(--bg-card); border-radius: 8px; border: 2px solid #8feeff; display: none; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
                        <h3
                            style="margin-bottom: 20px; color: #8feeff; font-size: 1.3rem; border-bottom: 2px solid #8feeff; padding-bottom: 10px;">
                            üìä Analysis Results</h3>
                        <div id="aiAnalysisContent"
                            style="line-height: 1.9; color: var(--text-primary); font-size: 0.95rem;"></div>
                    </div>

                    <div id="aiLoadingSpinner" style="display: none; text-align: center; margin-top: 20px;">
                        <div
                            style="display: inline-block; width: 40px; height: 40px; border: 4px solid var(--border-color); border-top-color: #8feeff; border-radius: 50%; animation: spin 1s linear infinite;">
                        </div>
                        <p style="margin-top: 10px; color: var(--text-secondary);">Analyzing your compensation...</p>
                    </div>
                </div>


                <!-- Levels.fyi Comparison -->
                <div class="chart-container">
                    <div class="section-header" onclick="toggleSection('levelsFyiSection')">
                        <h2>üìä Compare with Market Data</h2>
                        <span class="collapse-icon" id="levelsFyiIcon">‚ñº</span>
                    </div>
                    <div class="collapsible-content" id="levelsFyiSection">
                        <p style="font-size: 0.9rem; color: #57534e; margin-bottom: 15px;">
                            Use the interactive chart below to compare your compensation with market data from
                            levels.fyi
                        </p>

                        <div
                            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
                            <div>
                                <label for="levelsCompany"
                                    style="display: block; font-weight: 500; margin-bottom: 8px; font-size: 0.9rem;">Company</label>
                                <div class="autocomplete-wrapper">
                                    <input type="text" id="levelsCompany"
                                        style="width: 100%; padding: 10px; border: 2px solid var(--border-color); border-radius: 6px; font-size: 0.9rem; background: var(--bg-card); color: var(--text-primary);"
                                        placeholder="e.g., Meta" autocomplete="off">
                                </div>
                            </div>

                            <div>
                                <label for="levelsTrack"
                                    style="display: block; font-weight: 500; margin-bottom: 8px; font-size: 0.9rem;">Job
                                    Track</label>
                                <div class="autocomplete-wrapper">
                                    <input type="text" id="levelsTrack"
                                        style="width: 100%; padding: 10px; border: 2px solid var(--border-color); border-radius: 6px; font-size: 0.9rem; background: var(--bg-card); color: var(--text-primary);"
                                        placeholder="e.g., Software Engineer" autocomplete="off">
                                </div>
                            </div>
                        </div>

                        <iframe id="levelsIframe"
                            src="https://www.levels.fyi/charts_embed.html?company=Meta&track=Software%20Engineer&hide_selector=true"
                            height="500" style="width: 100%; border: 1px solid #e5e7eb; border-radius: 8px;"
                            frameborder="0" scrolling="auto">
                        </iframe>
                    </div>
                </div>


            </div>
            <!-- End RSU Calculator -->

            <!-- ISO Calculator Content -->
            <div id="isoCalculator" style="display: none;">
                <div class="inputs-grid-four">
                    <!-- Cash Compensation -->
                    <div class="input-section">
                        <div class="section-header" onclick="toggleSection('isoCashCompSection')">
                            <h2>Cash Compensation</h2>
                            <span class="collapse-icon" id="isoCashCompIcon">‚ñº</span>
                        </div>
                        <div class="collapsible-content" id="isoCashCompSection">
                            <div class="input-group">
                                <label for="isoBaseSalary">Base Salary ($)</label>
                                <input type="number" id="isoBaseSalary" min="0" step="1000" placeholder="0">
                            </div>

                            <div class="input-group">
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="checkbox" id="enableISOAnnualRaise" checked
                                        style="width: auto; margin-right: 10px; cursor: pointer;">
                                    <span>Apply 3% annual raise</span>
                                </label>
                            </div>

                            <div class="input-group">
                                <label for="isoBonusPercent">Bonus (%)</label>
                                <input type="number" id="isoBonusPercent" min="0" max="200" step="1" placeholder="0">
                            </div>

                            <div class="input-group">
                                <label for="isoSignOnBonus">Sign-On Bonus ($)</label>
                                <input type="number" id="isoSignOnBonus" min="0" step="1000" placeholder="0">
                                <p style="font-size: 0.75rem; color: #57534e; margin-top: 5px;">One-time payment in Year
                                    1
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- ISO Basics -->
                    <div class="input-section">
                        <div class="section-header" onclick="toggleSection('isoBasicsSection')">
                            <h2>ISO Basics</h2>
                            <span class="collapse-icon" id="isoBasicsIcon">‚ñº</span>
                        </div>
                        <div class="collapsible-content" id="isoBasicsSection">
                            <div class="input-group">
                                <label for="numberOfOptions">Number of Options</label>
                                <input type="number" id="numberOfOptions" min="0" step="100" placeholder="0">
                            </div>

                            <div class="input-group">
                                <label for="strikePrice">Strike Price ($)</label>
                                <input type="number" id="strikePrice" min="0" step="0.01" placeholder="0">
                            </div>

                            <div class="input-group">
                                <label for="assumedSharePrice">Assumed Future Share Price ($)</label>
                                <input type="number" id="assumedSharePrice" min="0" step="0.01" placeholder="0">
                            </div>
                        </div>
                    </div>

                    <!-- Vesting Schedule -->
                    <div class="input-section">
                        <div class="section-header" onclick="toggleSection('isoVestingSection')">
                            <h2>Vesting Schedule</h2>
                            <span class="collapse-icon" id="isoVestingIcon">‚ñº</span>
                        </div>
                        <div class="collapsible-content" id="isoVestingSection">
                            <div class="input-group">
                                <label for="hasCliff">1-Year Cliff</label>
                                <select id="hasCliff"
                                    style="width: 100%; padding: 10px; border: 2px solid var(--border-color); border-radius: 6px; font-size: 0.95rem; background: var(--bg-card); color: var(--text-primary);">
                                    <option value="yes">Yes (25% vests at 1 year)</option>
                                    <option value="no">No (Monthly vesting from start)</option>
                                </select>
                            </div>

                            <div class="input-group">
                                <label for="vestingPeriod">Total Vesting Period (Years)</label>
                                <input type="number" id="vestingPeriod" min="1" max="10" step="1" value="4">
                                <p style="font-size: 0.75rem; color: #57534e; margin-top: 5px;">Standard is 4 years</p>
                            </div>
                        </div>
                    </div>

                    <!-- Exercise Timing -->
                    <div class="input-section">
                        <div class="section-header" onclick="toggleSection('isoExerciseSection')">
                            <h2>Exercise & Tax</h2>
                            <span class="collapse-icon" id="isoExerciseIcon">‚ñº</span>
                        </div>
                        <div class="collapsible-content" id="isoExerciseSection">
                            <div class="input-group">
                                <label for="exerciseTiming">Exercise Timing</label>
                                <select id="exerciseTiming"
                                    style="width: 100%; padding: 10px; border: 2px solid var(--border-color); border-radius: 6px; font-size: 0.95rem; background: var(--bg-card); color: var(--text-primary);">
                                    <option value="at_vest">At Vest (as options vest)</option>
                                    <option value="at_exit" selected>At Exit (all at once)</option>
                                </select>
                            </div>

                            <div class="input-group">
                                <label for="isoState">State</label>
                                <select id="isoState" onchange="updateTaxProfileOptions()"
                                    style="width: 100%; padding: 10px; border: 2px solid var(--border-color); border-radius: 6px; font-size: 0.95rem; background: var(--bg-card); color: var(--text-primary);">
                                    <option value="">Select state...</option>
                                    <option value="CA" selected>California</option>
                                    <option value="NY">New York</option>
                                    <option value="TX">Texas</option>
                                    <option value="FL">Florida</option>
                                    <option value="WA">Washington</option>
                                    <option value="MA">Massachusetts</option>
                                    <option value="IL">Illinois</option>
                                    <option value="PA">Pennsylvania</option>
                                    <option value="CO">Colorado</option>
                                    <option value="OR">Oregon</option>
                                    <option value="NV">Nevada</option>
                                    <option value="TN">Tennessee</option>
                                    <option value="AZ">Arizona</option>
                                    <option value="NC">North Carolina</option>
                                    <option value="GA">Georgia</option>
                                    <option value="VA">Virginia</option>
                                    <option value="NJ">New Jersey</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>

                            <div class="input-group">
                                <label for="taxProfile">Tax Profile</label>
                                <select id="taxProfile" onchange="applyTaxProfile()"
                                    style="width: 100%; padding: 10px; border: 2px solid var(--border-color); border-radius: 6px; font-size: 0.95rem; background: var(--bg-card); color: var(--text-primary);">
                                    <option value="">Select a profile...</option>
                                    <option value="ca_high">Single, CA high earner ‚Üí 40%</option>
                                    <option value="ca_married">Married, CA ‚Üí 37%</option>
                                    <option value="no_income_tax">No-income-tax state ‚Üí 32%</option>
                                    <option value="custom">Custom ‚Üí unlocks manual entry</option>
                                </select>
                            </div>

                            <div class="input-group">
                                <label for="marginalTaxRate">Marginal Tax Rate % (on ISO gains)</label>
                                <input type="number" id="marginalTaxRate" min="0" max="100" step="0.1" placeholder="37"
                                    disabled>
                                <p style="font-size: 0.75rem; color: #57534e; margin-top: 5px;">Estimated combined
                                    federal +
                                    state rate applied to ISO gains. Not the same as tax withholding.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ISO Summary Cards -->
                <div class="summary-grid">
                    <div class="summary-card">
                        <div class="summary-label">üí∏ Exercise Cost</div>
                        <div class="summary-value" id="isoExerciseCost" onclick="copyToClipboard(this)"
                            style="cursor: pointer;" title="Click to copy">$0</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-label">üìà Gross Upside</div>
                        <div class="summary-value" id="isoGrossUpside" onclick="copyToClipboard(this)"
                            style="cursor: pointer;" title="Click to copy">$0</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-label">üßæ Estimated Taxes</div>
                        <div class="summary-value" id="isoEstimatedTaxes" onclick="copyToClipboard(this)"
                            style="cursor: pointer;" title="Click to copy">$0</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-label">‚úÖ Net Upside</div>
                        <div class="summary-value" id="isoNetUpside" onclick="copyToClipboard(this)"
                            style="cursor: pointer;" title="Click to copy">$0</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-label">üìä ROI Multiple</div>
                        <div class="summary-value" id="isoROI" onclick="copyToClipboard(this)" style="cursor: pointer;"
                            title="Click to copy">0x</div>
                    </div>
                </div>

                <!-- ISO Scenario Chart -->
                <div class="chart-container">
                    <div class="section-header" onclick="toggleSection('isoScenarioChartSection')">
                        <h2>Compensation + ISO Upside Scenarios</h2>
                        <span class="collapse-icon" id="isoScenarioChartIcon">‚ñº</span>
                    </div>
                    <div class="collapsible-content" id="isoScenarioChartSection">
                        <!-- Slider for scenario adjustment -->
                        <div
                            style="margin-bottom: 20px; padding: 15px; background: var(--bg-card); border-radius: 8px; border: 1px solid var(--border-color);">
                            <label for="scenarioSharePrice"
                                style="display: block; font-weight: 600; margin-bottom: 10px; color: var(--text-primary);">
                                Scenario Share Price: $<span id="scenarioSharePriceDisplay">0</span>
                            </label>
                            <input type="range" id="scenarioSharePrice" min="0" max="500" step="1" value="0"
                                style="width: 100%; height: 8px; border-radius: 4px; background: var(--bg-secondary); outline: none; cursor: pointer;">
                            <div
                                style="display: flex; justify-content: space-between; margin-top: 5px; font-size: 0.85rem; color: var(--text-secondary);">
                                <span id="sliderMinLabel">$0</span>
                                <span id="sliderMaxLabel">$500</span>
                            </div>
                        </div>
                        <canvas id="isoScenarioChart"></canvas>
                    </div>
                </div>

                <!-- ISO Detailed Breakdown Table -->
                <div class="table-container">
                    <div class="section-header" onclick="toggleSection('isoTableSection')">
                        <h2>Year-by-Year Breakdown</h2>
                        <span class="collapse-icon" id="isoTableIcon">‚ñº</span>
                    </div>
                    <div class="collapsible-content" id="isoTableSection">
                        <table id="isoBreakdownTable">
                            <thead>
                                <tr>
                                    <th>Year</th>
                                    <th>Base Salary</th>
                                    <th>Target Variable</th>
                                    <th>Sign-On</th>
                                    <th>Total Cash</th>
                                    <th>ISO Upside (Annual)</th>
                                    <th>Total w/ ISO</th>
                                </tr>
                            </thead>
                            <tbody id="isoTableBody">
                                <!-- Populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
            <!-- End ISO Calculator -->

        </div>
        <!-- End Calculator Section -->

    </div>

    <script>
        // Onboarding state management
        const onboardingData = {
            role: '',
            location: '',
            yearsExp: '',
            industry: '',
            company: '',
            cashType: 'straight',
            equityType: 'none'
        };

        // Navigation functions
        function goToStep2() {
            const role = document.getElementById('onboardRole').value.trim();
            const location = document.getElementById('onboardLocation').value.trim();
            const yearsExp = document.getElementById('onboardYearsExp').value;
            const industry = document.getElementById('onboardIndustry').value.trim();

            if (!role || !location || !yearsExp || !industry) {
                alert('Please fill in all required fields');
                return;
            }

            onboardingData.role = role;
            onboardingData.location = location;
            onboardingData.yearsExp = yearsExp;
            onboardingData.industry = industry;
            onboardingData.company = document.getElementById('onboardCompany').value.trim();

            document.getElementById('onboardingStep1').style.display = 'none';
            document.getElementById('onboardingStep2').style.display = 'block';
        }

        function goToStep1() {
            document.getElementById('onboardingStep2').style.display = 'none';
            document.getElementById('onboardingStep1').style.display = 'block';
        }

        function editCompStructure() {
            console.log('Editing compensation structure');

            // Pre-fill Step 2 with current selections
            const currentCashType = onboardingData.cashType || 'straight';
            const currentEquityType = onboardingData.equityType || 'none';

            // Set radio buttons to current values
            const cashRadio = document.querySelector(`input[name="cashType"][value="${currentCashType}"]`);
            const equityRadio = document.querySelector(`input[name="equityType"][value="${currentEquityType}"]`);

            if (cashRadio) cashRadio.checked = true;
            if (equityRadio) equityRadio.checked = true;

            // Hide calculator, show onboarding step 2
            document.getElementById('calculatorSection').style.display = 'none';
            document.getElementById('onboardingFlow').style.display = 'block';
            document.getElementById('onboardingStep1').style.display = 'none';
            document.getElementById('onboardingStep2').style.display = 'block';
        }

        function completeOnboarding() {
            console.log('=== completeOnboarding START ===');

            const cashTypeEl = document.querySelector('input[name="cashType"]:checked');
            const equityTypeEl = document.querySelector('input[name="equityType"]:checked');

            console.log('Cash type element:', cashTypeEl);
            console.log('Equity type element:', equityTypeEl);

            if (!cashTypeEl || !equityTypeEl) {
                console.error('Missing radio button selection!');
                alert('Please select both cash and equity options');
                return;
            }

            const cashType = cashTypeEl.value;
            const equityType = equityTypeEl.value;

            console.log('Cash type:', cashType);
            console.log('Equity type:', equityType);

            onboardingData.cashType = cashType;
            onboardingData.equityType = equityType;

            console.log('Saving onboarding data:', onboardingData);
            localStorage.setItem('onboardingCompleted', 'true');
            localStorage.setItem('onboardingData', JSON.stringify(onboardingData));

            // Update profile banner
            console.log('Updating profile banner...');
            try {
                updateProfileBanner();
            } catch (e) {
                console.error('Error updating profile banner:', e);
            }

            console.log('Calling showCalculator with:', equityType);
            try {
                showCalculator(equityType);
            } catch (e) {
                console.error('Error in showCalculator:', e);
            }

            console.log('Hiding onboarding, showing calculator...');
            const onboardingFlow = document.getElementById('onboardingFlow');
            const calculatorSection = document.getElementById('calculatorSection');
            const startOverBtn = document.getElementById('startOverBtn');

            console.log('Onboarding flow element:', onboardingFlow);
            console.log('Calculator section element:', calculatorSection);
            console.log('Start over button:', startOverBtn);

            if (onboardingFlow) onboardingFlow.style.display = 'none';
            if (calculatorSection) {
                calculatorSection.style.display = 'block';
                console.log('Calculator section display set to block!');
            } else {
                console.error('Calculator section not found!');
            }
            if (startOverBtn) startOverBtn.style.display = 'block';

            // Pre-fill AI analyzer fields AFTER calculator is visible
            console.log('Pre-filling AI fields...');
            setTimeout(() => {
                try {
                    const aiRole = document.getElementById('aiRole');
                    const aiLocation = document.getElementById('aiLocation');
                    const aiYearsExp = document.getElementById('aiYearsExp');
                    const aiIndustry = document.getElementById('aiIndustry');

                    if (aiRole) aiRole.value = onboardingData.role;
                    if (aiLocation) aiLocation.value = onboardingData.location;
                    if (aiYearsExp) aiYearsExp.value = onboardingData.yearsExp;
                    if (aiIndustry) aiIndustry.value = onboardingData.industry;

                    if (aiRole && aiLocation && aiYearsExp && aiIndustry) {
                        saveAIInputs();
                    } else {
                        console.warn('Some AI fields not found, skipping save');
                    }
                } catch (e) {
                    console.error('Error pre-filling AI fields:', e);
                }
            }, 100);

            console.log('=== completeOnboarding END ===');
        }

        function updateProfileBanner() {
            try {
                const data = onboardingData;

                // Update role and details
                const roleEl = document.getElementById('profileRole');
                const detailsEl = document.getElementById('profileDetails');
                const badgeEl = document.getElementById('profileBadge');

                if (roleEl) roleEl.textContent = data.role;
                if (detailsEl) {
                    detailsEl.textContent =
                        `${data.location} ‚Ä¢ ${data.yearsExp} years ‚Ä¢ ${data.industry}${data.company ? ` ‚Ä¢ ${data.company}` : ''}`;
                }

                // Update badge based on comp structure
                if (badgeEl) {
                    let badgeText = '';

                    if (data.equityType === 'none') {
                        badgeText = data.cashType === 'commission' ? 'üìà Salary + Commission' : 'üíµ Cash Only';
                    } else if (data.equityType === 'rsu') {
                        badgeText = 'üìä Cash + RSUs';
                    } else if (data.equityType === 'iso') {
                        badgeText = 'üéØ Cash + ISOs';
                    }

                    badgeEl.textContent = badgeText;
                }

                // Update AI summary section
                updateAISummary();

                console.log('Profile banner updated successfully');
            } catch (error) {
                console.error('Error updating profile banner:', error);
            }
        }

        function updateAISummary() {
            try {
                const data = onboardingData;

                // Update AI analysis summary fields
                const summaryRole = document.getElementById('aiSummaryRole');
                const summaryLocation = document.getElementById('aiSummaryLocation');
                const summaryYears = document.getElementById('aiSummaryYears');
                const summaryIndustry = document.getElementById('aiSummaryIndustry');
                const summaryCompany = document.getElementById('aiSummaryCompany');

                if (summaryRole) summaryRole.textContent = data.role || '-';
                if (summaryLocation) summaryLocation.textContent = data.location || '-';
                if (summaryYears) summaryYears.textContent = data.yearsExp ? `${data.yearsExp} years` : '-';
                if (summaryIndustry) summaryIndustry.textContent = data.industry || '-';
                if (summaryCompany) summaryCompany.textContent = data.company || 'Not specified';

                console.log('AI summary updated successfully');
            } catch (error) {
                console.error('Error updating AI summary:', error);
            }
        }

        function showCalculator(equityType) {
            console.log('=== showCalculator START ===');
            console.log('Equity type:', equityType);

            // Get calculator elements
            const rsuCalc = document.getElementById('rsuCalculator');
            const isoCalc = document.getElementById('isoCalculator');
            const rsuGrantsInput = document.getElementById('rsuGrantsInputSection');
            const stockPriceInput = document.getElementById('stockPriceInputSection');

            console.log('RSU Calculator element:', rsuCalc);
            console.log('ISO Calculator element:', isoCalc);
            console.log('RSU Grants section:', rsuGrantsInput);
            console.log('Stock Price section:', stockPriceInput);

            // Hide both calculators first
            if (rsuCalc) rsuCalc.style.display = 'none';
            if (isoCalc) isoCalc.style.display = 'none';

            // Show/hide commission vs straight salary modes
            const isCommission = onboardingData.cashType === 'commission';
            const straightMode = document.getElementById('straightSalaryMode');
            const commissionMode = document.getElementById('commissionMode');

            if (straightMode) straightMode.style.display = isCommission ? 'none' : 'block';
            if (commissionMode) commissionMode.style.display = isCommission ? 'block' : 'none';

            if (equityType === 'rsu') {
                console.log('>>> Showing RSU calculator with equity');
                if (rsuCalc) rsuCalc.style.display = 'block';
                currentMode = 'rsu';

                // Show all equity sections for RSU
                if (rsuGrantsInput) {
                    console.log('Showing RSU grants section');
                    rsuGrantsInput.style.display = 'block';
                }
                if (stockPriceInput) {
                    console.log('Showing stock price section');
                    stockPriceInput.style.display = 'block';
                }

                updateDisplay();
            } else if (equityType === 'iso') {
                console.log('>>> Showing ISO calculator');
                if (isoCalc) isoCalc.style.display = 'block';
                currentMode = 'iso';
                updateISODisplay();
            } else {
                console.log('>>> Showing cash-only calculator (RSU calc without equity)');
                // No equity - show RSU calculator with equity sections hidden
                if (rsuCalc) {
                    rsuCalc.style.display = 'block';
                    console.log('RSU Calculator display set to block');
                }
                currentMode = 'cash-only';

                // Hide equity-related sections
                if (rsuGrantsInput) {
                    console.log('Hiding RSU grants section');
                    rsuGrantsInput.style.display = 'none';
                }
                if (stockPriceInput) {
                    console.log('Hiding stock price section');
                    stockPriceInput.style.display = 'none';
                }

                // Set equity values to 0
                const fields = ['initialGrant', 'stockYear1', 'stockYear2', 'stockYear3', 'stockYear4'];
                fields.forEach(field => {
                    const el = document.getElementById(field);
                    if (el) el.value = 0;
                });

                const refreshers = document.getElementById('enableRefreshers');
                if (refreshers) refreshers.checked = false;

                console.log('Calling updateDisplay...');
                updateDisplay();
            }

            console.log('=== showCalculator END ===');
        }

        // OTE/Commission calculations
        function setupOTEListeners() {
            const oteToggle = document.getElementById('oteInputMode');
            const baseVariableInputs = document.getElementById('baseVariableInputs');
            const oteInputs = document.getElementById('oteInputs');

            if (oteToggle) {
                oteToggle.addEventListener('change', function () {
                    if (this.checked) {
                        baseVariableInputs.style.display = 'none';
                        oteInputs.style.display = 'block';
                        calculateFromOTE();
                    } else {
                        baseVariableInputs.style.display = 'block';
                        oteInputs.style.display = 'none';
                        calculateOTE();
                    }
                });
            }

            // Base + Variable mode listeners
            const commissionBase = document.getElementById('commissionBase');
            const targetVariable = document.getElementById('targetVariable');

            if (commissionBase) {
                commissionBase.addEventListener('input', function () {
                    calculateOTE();
                    updateDisplay();
                    saveInputs();
                });
            }
            if (targetVariable) {
                targetVariable.addEventListener('input', function () {
                    calculateOTE();
                    updateDisplay();
                    saveInputs();
                });
            }

            // OTE mode listeners
            const oteAmount = document.getElementById('oteAmount');
            const baseSplit = document.getElementById('baseSplit');

            if (oteAmount) {
                oteAmount.addEventListener('input', function () {
                    calculateFromOTE();
                    updateDisplay();
                    saveInputs();
                });
            }
            if (baseSplit) {
                baseSplit.addEventListener('input', function () {
                    calculateFromOTE();
                    updateDisplay();
                    saveInputs();
                });
            }

            // Annual raise checkbox for commission mode
            const enableAnnualRaiseComm = document.getElementById('enableAnnualRaiseComm');
            if (enableAnnualRaiseComm) {
                enableAnnualRaiseComm.addEventListener('change', function () {
                    updateDisplay();
                    saveInputs();
                });
            }
        }

        function calculateOTE() {
            const base = parseFloat(document.getElementById('commissionBase').value) || 0;
            const variable = parseFloat(document.getElementById('targetVariable').value) || 0;
            const ote = base + variable;

            document.getElementById('calculatedOTE').textContent = '$' + ote.toLocaleString();

            // Sync to baseSalary and bonusPercent for calculations
            document.getElementById('baseSalary').value = base;

            // Calculate bonus percent: (variable / base) * 100
            if (base > 0) {
                const bonusPercent = (variable / base) * 100;
                document.getElementById('bonusPercent').value = bonusPercent.toFixed(1);
            } else {
                document.getElementById('bonusPercent').value = 0;
            }
        }

        function calculateFromOTE() {
            const ote = parseFloat(document.getElementById('oteAmount').value) || 0;
            const baseSplit = parseFloat(document.getElementById('baseSplit').value) || 70;

            const base = Math.round(ote * (baseSplit / 100));
            const variable = ote - base;

            document.getElementById('calculatedBase').textContent = '$' + base.toLocaleString();
            document.getElementById('calculatedVariable').textContent = '$' + variable.toLocaleString();

            // Sync to baseSalary and bonusPercent for calculations
            document.getElementById('baseSalary').value = base;

            // Calculate bonus percent: (variable / base) * 100
            if (base > 0) {
                const bonusPercent = (variable / base) * 100;
                document.getElementById('bonusPercent').value = bonusPercent.toFixed(1);
            } else {
                document.getElementById('bonusPercent').value = 0;
            }
        }

        function checkOnboardingStatus() {
            const completed = localStorage.getItem('onboardingCompleted');
            const data = localStorage.getItem('onboardingData');

            if (completed === 'true' && data) {
                const savedData = JSON.parse(data);
                Object.assign(onboardingData, savedData);

                document.getElementById('onboardingFlow').style.display = 'none';
                document.getElementById('calculatorSection').style.display = 'block';
                document.getElementById('startOverBtn').style.display = 'block';

                // Update profile banner
                updateProfileBanner();

                showCalculator(savedData.equityType);

                // Pre-fill AI fields
                if (document.getElementById('aiRole')) {
                    document.getElementById('aiRole').value = savedData.role;
                    document.getElementById('aiLocation').value = savedData.location;
                    document.getElementById('aiYearsExp').value = savedData.yearsExp;
                    document.getElementById('aiIndustry').value = savedData.industry;
                }
            } else {
                document.getElementById('onboardingFlow').style.display = 'block';
                document.getElementById('calculatorSection').style.display = 'none';
                document.getElementById('startOverBtn').style.display = 'none';
            }
        }

        function resetOnboarding() {
            if (confirm('This will reset all your data and start fresh. Continue?')) {
                localStorage.removeItem('onboardingCompleted');
                localStorage.removeItem('onboardingData');
                location.reload();
            }
        }

        // AI Compensation Analysis with Google Gemini
        async function analyzeCompensation() {
            // Use onboarding data instead of input fields
            const role = onboardingData.role;
            const location = onboardingData.location;
            const yearsExp = onboardingData.yearsExp;
            const industry = onboardingData.industry;
            const company = onboardingData.company || 'Not specified';

            // Validation - these should always be present from onboarding
            if (!role || !location || !yearsExp || !industry) {
                alert('Missing profile information. Please start over and complete the onboarding flow.');
                return;
            }

            // Get current compensation data from calculator
            const baseSalary = parseInt(document.getElementById('baseSalary').value) || 0;
            const bonusPercent = parseFloat(document.getElementById('bonusPercent').value) || 0;
            const signOnBonus = parseInt(document.getElementById('signOnBonus').value) || 0;
            const initialGrant = parseFloat(document.getElementById('initialGrant').value) || 0;

            // Get stock prices
            const stockYear1 = parseFloat(document.getElementById('stockYear1').value) || 0;
            const stockYear4 = parseFloat(document.getElementById('stockYear4').value) || 0;

            // Calculate Year 1 total
            const year1Bonus = baseSalary * (bonusPercent / 100);
            const year1RSUValue = initialGrant * 0.4 * stockYear1; // 40% vests in year 1
            const year1Total = baseSalary + year1Bonus + signOnBonus + year1RSUValue;

            // Calculate 4-year average
            const avgAnnual = (year1Total + (baseSalary * 3 * 1.1) + year1RSUValue * 3) / 4; // Rough estimate

            // Show loading
            document.getElementById('aiLoadingSpinner').style.display = 'block';
            document.getElementById('aiAnalysisResult').style.display = 'none';
            document.getElementById('analyzeBtn').disabled = true;
            document.getElementById('analyzeBtn').style.opacity = '0.6';
            document.getElementById('analyzeBtn').textContent = 'Analyzing...';

            try {
                const prompt = `You are a compensation expert. Analyze this compensation package and compare it to industry standards.

Role: ${role}
Location: ${location}
Years of Experience: ${yearsExp}
Industry: ${industry}
Company: ${company}

Current Compensation Package:
- Base Salary: $${baseSalary.toLocaleString()}
- Annual Bonus: ${bonusPercent}% ($${year1Bonus.toLocaleString()})
- Sign-On Bonus: $${signOnBonus.toLocaleString()}
- Initial RSU Grant: ${initialGrant.toLocaleString()} shares
- Stock Price (Year 1): $${stockYear1}
- Year 1 Total Comp: $${Math.round(year1Total).toLocaleString()}
- 4-Year Average Annual: ~$${Math.round(avgAnnual).toLocaleString()}

Please provide a comprehensive analysis covering:
1. **Market Comparison**: How does this package compare to ${industry} industry standards for this role, location, and experience level? Consider industry-specific compensation trends and norms.
2. **Strengths**: What are the strongest components of this offer?
3. **Weaknesses**: What could be improved or negotiated?
4. **Risk Assessment**: Comment on the equity/cash balance and stock price assumptions, especially in the context of the ${industry} industry
5. **Recommendations**: Specific suggestions for negotiation or evaluation

Format your response in clear sections with bullet points. Be specific with salary ranges when possible, taking into account ${industry} industry standards.`;

                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        prompt: prompt
                    })
                });

                if (!response.ok) {
                    let errorMessage = 'API request failed';
                    let errorDetails = '';
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.error || errorMessage;
                        errorDetails = JSON.stringify(errorData, null, 2);
                        console.error('API Error Details:', errorData);
                    } catch (e) {
                        // If response isn't JSON, get text
                        const errorText = await response.text();
                        errorMessage = errorText || `Server error: ${response.status}`;
                        errorDetails = errorText;
                        console.error('API Error Text:', errorText);
                    }
                    throw new Error(errorMessage + '\n\nDetails: ' + errorDetails);
                }

                const data = await response.json();

                // Check if we have the expected response structure
                if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
                    throw new Error('Invalid response from API');
                }

                const analysisText = data.candidates[0].content.parts[0].text;

                // Format the markdown-style text for better display
                const formattedText = analysisText
                    // Convert ## headers to styled headers (using orange that works in both modes)
                    .replace(/###\s+(.+)/g, '<h4 style="color: #ff630f; margin-top: 25px; margin-bottom: 10px; font-size: 1.1rem; font-weight: 600;">$1</h4>')
                    .replace(/##\s+(.+)/g, '<h3 style="color: #ff630f; margin-top: 30px; margin-bottom: 12px; font-size: 1.2rem; font-weight: 700;">$1</h3>')
                    // Convert **bold** to actual bold (inherits text color)
                    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                    // Convert * bullet points to styled bullets (inherits text color)
                    .replace(/^\*\s+(.+)$/gm, '<div style="margin-left: 20px; margin-bottom: 8px;">‚Ä¢ $1</div>')
                    // Convert numbered lists (inherits text color)
                    .replace(/^(\d+)\.\s+(.+)$/gm, '<div style="margin-left: 20px; margin-bottom: 8px; font-weight: 600;">$1. $2</div>')
                    // Convert line breaks
                    .replace(/\n\n/g, '<br><br>')
                    .replace(/\n/g, '<br>');

                // Display results
                document.getElementById('aiAnalysisContent').innerHTML = formattedText;
                document.getElementById('aiAnalysisResult').style.display = 'block';

                // Scroll to results
                document.getElementById('aiAnalysisResult').scrollIntoView({ behavior: 'smooth', block: 'start' });

            } catch (error) {
                let errorMsg = error.message;

                // Provide more helpful error messages
                if (errorMsg.includes('valid JSON')) {
                    errorMsg = 'Server configuration error. Please check that the /api folder is properly deployed to Vercel.';
                } else if (errorMsg.includes('Failed to fetch')) {
                    errorMsg = 'Network error. Please check your connection and try again.';
                }

                alert(`Error analyzing compensation: ${errorMsg}`);
                console.error('Analysis Error:', error);
            } finally {
                // Hide loading
                document.getElementById('aiLoadingSpinner').style.display = 'none';
                document.getElementById('analyzeBtn').disabled = false;
                document.getElementById('analyzeBtn').style.opacity = '1';
                document.getElementById('analyzeBtn').textContent = 'Analyze My Compensation üöÄ';
            }
        }

        // AI Analyzer - Save and Load inputs
        function saveAIInputs() {
            // No longer needed - AI uses onboarding data directly
        }

        function loadAIInputs() {
            // No longer needed - AI uses onboarding data directly
        }

        // Add event listeners for AI analyzer inputs
        function setupAIInputListeners() {
            // No longer needed - AI uses onboarding data directly
            // Fields removed in favor of onboarding data summary
        }

        // Custom Autocomplete Function
        function autocomplete(inp, arr) {
            let currentFocus;

            inp.addEventListener("input", function (e) {
                let a, b, i, val = this.value;
                closeAllLists();
                if (!val) { return false; }
                currentFocus = -1;

                a = document.createElement("DIV");
                a.setAttribute("id", this.id + "autocomplete-list");
                a.setAttribute("class", "autocomplete-items");
                this.parentNode.appendChild(a);

                let count = 0;
                for (i = 0; i < arr.length; i++) {
                    if (arr[i].substr(0, val.length).toUpperCase() == val.toUpperCase()) {
                        b = document.createElement("DIV");
                        b.innerHTML = "<strong>" + arr[i].substr(0, val.length) + "</strong>";
                        b.innerHTML += arr[i].substr(val.length);
                        b.innerHTML += "<input type='hidden' value='" + arr[i] + "'>";
                        b.addEventListener("click", function (e) {
                            inp.value = this.getElementsByTagName("input")[0].value;
                            saveAIInputs();
                            closeAllLists();
                        });
                        a.appendChild(b);
                        count++;
                        if (count >= 10) break; // Limit to 10 results
                    }
                }
            });

            inp.addEventListener("keydown", function (e) {
                let x = document.getElementById(this.id + "autocomplete-list");
                if (x) x = x.getElementsByTagName("div");
                if (e.keyCode == 40) {
                    currentFocus++;
                    addActive(x);
                } else if (e.keyCode == 38) {
                    currentFocus--;
                    addActive(x);
                } else if (e.keyCode == 13) {
                    e.preventDefault();
                    if (currentFocus > -1) {
                        if (x) x[currentFocus].click();
                    }
                }
            });

            function addActive(x) {
                if (!x) return false;
                removeActive(x);
                if (currentFocus >= x.length) currentFocus = 0;
                if (currentFocus < 0) currentFocus = (x.length - 1);
                x[currentFocus].classList.add("autocomplete-active");
            }

            function removeActive(x) {
                for (let i = 0; i < x.length; i++) {
                    x[i].classList.remove("autocomplete-active");
                }
            }

            function closeAllLists(elmnt) {
                let x = document.getElementsByClassName("autocomplete-items");
                for (let i = 0; i < x.length; i++) {
                    if (elmnt != x[i] && elmnt != inp) {
                        x[i].parentNode.removeChild(x[i]);
                    }
                }
            }

            document.addEventListener("click", function (e) {
                closeAllLists(e.target);
            });
        }

        // Initialize autocomplete with role and location options
        function initializeAutocomplete() {
            const roles = [
                "Software Engineer", "Senior Software Engineer", "Staff Software Engineer",
                "Principal Software Engineer", "Engineering Manager", "Senior Engineering Manager",
                "Product Manager", "Senior Product Manager", "Principal Product Manager",
                "Data Scientist", "Senior Data Scientist", "Machine Learning Engineer",
                "Senior ML Engineer", "DevOps Engineer", "Site Reliability Engineer",
                "Security Engineer", "Frontend Engineer", "Backend Engineer",
                "Full Stack Engineer", "Mobile Engineer (iOS)", "Mobile Engineer (Android)",
                "Technical Program Manager", "Product Designer", "Data Engineer", "Associate Attorney",
                "Senior Associate Attorney",
                "Counsel",
                "Senior Counsel",
                "Corporate Counsel",
                "Associate General Counsel",
                "General Counsel",
                "Litigation Attorney",
                "Staff Attorney",
                "Paralegal",
                "Legal Operations Manager", "Physician",
                "Attending Physician",
                "Resident Physician",
                "Surgeon",
                "Nurse Practitioner",
                "Physician Assistant",
                "Registered Nurse",
                "Clinical Manager",
                "Healthcare Administrator",
                "Medical Director",
                "Financial Analyst",
                "Senior Financial Analyst",
                "Investment Banking Analyst",
                "Investment Banking Associate",
                "Finance Manager",
                "Vice President of Finance",
                "Portfolio Manager",
                "Private Equity Associate",
                "Controller",
                "Chief Financial Officer", "Marketing Coordinator",
                "Marketing Manager",
                "Senior Marketing Manager",
                "Growth Marketing Manager",
                "Product Marketing Manager",
                "Demand Generation Manager",
                "Brand Manager",
                "Content Marketing Manager",
                "Director of Marketing",
                "Vice President of Marketing", "Sales Development Representative",
                "Business Development Representative",
                "Account Executive",
                "Senior Account Executive",
                "Enterprise Account Executive",
                "Strategic Account Executive",
                "Sales Manager",
                "Regional Sales Manager",
                "Director of Sales",
                "Vice President of Sales",
                "Customer Success Manager",
                "Customer Success Engineer",
                "Senior Customer Success Manager",
                "Enterprise Customer Success Manager",
                "Technical Customer Success Manager",
                "Customer Success Operations Manager",
                "Account Manager",
                "Renewal Manager",
                "Director of Customer Success",
                "Vice President of Customer Success",
                "Sales Engineer",
                "Senior Sales Engineer",
                "Principal Sales Engineer",
                "Solutions Engineer",
                "Solutions Consultant",
                "Pre-Sales Engineer",
                "Lead Sales Engineer",
                "Manager, Sales Engineering",
                "Director of Sales Engineering"
            ];

            const locations = [
                "San Francisco, CA", "San Jose, CA", "Mountain View, CA", "Palo Alto, CA",
                "Sunnyvale, CA", "Santa Clara, CA", "Cupertino, CA", "Seattle, WA",
                "Austin, TX", "New York, NY", "Boston, MA", "Los Angeles, CA",
                "San Diego, CA", "Denver, CO", "Portland, OR", "Chicago, IL",
                "Atlanta, GA", "Raleigh, NC", "Washington, DC", "Miami, FL"
            ];

            const industries = [
                "Technology", "Finance", "Healthcare", "Retail", "E-commerce",
                "Entertainment", "Sports", "Media", "Telecommunications", "Education",
                "Consulting", "Manufacturing", "Real Estate", "Insurance", "Energy",
                "Pharmaceuticals", "Biotechnology", "Automotive", "Aerospace", "Defense",
                "Hospitality", "Transportation", "Logistics", "Agriculture", "Government"
            ];

            const companies = [
                "Meta",
                "Google",
                "Microsoft",
                "Amazon",
                "Apple",
                "Netflix",
                "Uber",
                "Lyft",
                "Airbnb",
                "Dropbox",
                "Yahoo",
                "Pinterest",
                "PayPal",
                "Intel",
                "IBM",
                "Salesforce",
                "Cisco",
                "Workday",
                "LinkedIn",
                "eBay",
                "Oracle",
                "Intuit",
                "Qualcomm",
                "VMware",
                "Square",
                "DoorDash",
                "Snap",
                "Comcast",
                "Stripe",
                "Quora",
                "Yelp",
                "Adobe",
                "Nextdoor",
                "Spotify",
                "Twitter",
                "Zillow",
                "Tesla",
                "Groupon",
                "SAP",
                "Indeed",
                "Symantec",
                "NetApp",
                "Waymo",
                "Nvidia",
                "AMD",
                "Snowflake",
                "Databricks",
                "Atlassian",
                "Twilio",
                "GitHub",
                "GitLab",
                "Asana",
                "Notion",
                "Figma",
                "Slack",
                "Zoom",
                "Coinbase",
                "Robinhood",
                "Affirm",
                "Shopify",
                "Roblox",
                "Unity",
                "Epic Games",
                "Reddit",
                "Discord",
                "Instacart",
                "Grubhub",
                "Expedia",
                "Booking.com",
                "Box",
                "Cloudflare",
                "Datadog",
                "Splunk",
                "MongoDB",
                "Elastic",
                "Palantir",
                "Cruise",
                "Rivian",
                "Bloomberg",
                "Citadel",
                "Two Sigma",
                "Jane Street",
                "Goldman Sachs",
                "JPMorgan",
                "Morgan Stanley",
                "Palo Alto Networks",
                "Crusoe",
                "San Jose Sharks",
                "Ramp",
                "Anthropic",
                "OpenAI",

                // Added Fortune 500 (not already in your list)
                "Walmart",
                "Costco",
                "Target",
                "Home Depot",
                "Lowe‚Äôs",
                "Best Buy",
                "FedEx",
                "UPS",
                "American Express",
                "Capital One",
                "Visa",
                "Mastercard",
                "American Airlines",
                "Delta Air Lines",
                "United Airlines",
                "Ford",
                "General Motors",
                "Boeing",
                "Lockheed Martin",
                "Northrop Grumman",
                "Raytheon",
                "General Electric",
                "Johnson & Johnson",
                "Pfizer",
                "UnitedHealth Group",
                "CVS Health",
                "Anthem",
                "Cigna",
                "Procter & Gamble",
                "Coca-Cola",
                "PepsiCo",
                "McDonald‚Äôs",
                "Starbucks",
                "Nike",
                "Kaiser Permanente"
            ];

            const jobTracks = [
                "Software Engineer", "Senior Software Engineer", "Staff Software Engineer",
                "Principal Software Engineer", "Engineering Manager", "Senior Engineering Manager",
                "Product Manager", "Senior Product Manager", "Principal Product Manager",
                "Data Scientist", "Senior Data Scientist", "Machine Learning Engineer",
                "Senior ML Engineer", "DevOps Engineer", "Site Reliability Engineer",
                "Security Engineer", "Frontend Engineer", "Backend Engineer",
                "Full Stack Engineer", "Mobile Engineer (iOS)", "Mobile Engineer (Android)",
                "Technical Program Manager", "Product Designer", "Data Engineer", "Associate Attorney",
                "Senior Associate Attorney",
                "Counsel",
                "Senior Counsel",
                "Corporate Counsel",
                "Associate General Counsel",
                "General Counsel",
                "Litigation Attorney",
                "Staff Attorney",
                "Paralegal",
                "Legal Operations Manager", "Physician",
                "Attending Physician",
                "Resident Physician",
                "Surgeon",
                "Nurse Practitioner",
                "Physician Assistant",
                "Registered Nurse",
                "Clinical Manager",
                "Healthcare Administrator",
                "Medical Director",
                "Financial Analyst",
                "Senior Financial Analyst",
                "Investment Banking Analyst",
                "Investment Banking Associate",
                "Finance Manager",
                "Vice President of Finance",
                "Portfolio Manager",
                "Private Equity Associate",
                "Controller",
                "Chief Financial Officer", "Marketing Coordinator",
                "Marketing Manager",
                "Senior Marketing Manager",
                "Growth Marketing Manager",
                "Product Marketing Manager",
                "Demand Generation Manager",
                "Brand Manager",
                "Content Marketing Manager",
                "Director of Marketing",
                "Vice President of Marketing", "Sales Development Representative",
                "Business Development Representative",
                "Account Executive",
                "Senior Account Executive",
                "Enterprise Account Executive",
                "Strategic Account Executive",
                "Sales Manager",
                "Regional Sales Manager",
                "Director of Sales",
                "Vice President of Sales",
                "Customer Success Manager",
                "Customer Success Engineer",
                "Senior Customer Success Manager",
                "Enterprise Customer Success Manager",
                "Technical Customer Success Manager",
                "Customer Success Operations Manager",
                "Account Manager",
                "Renewal Manager",
                "Director of Customer Success",
                "Vice President of Customer Success",
                "Sales Engineer",
                "Senior Sales Engineer",
                "Principal Sales Engineer",
                "Solutions Engineer",
                "Solutions Consultant",
                "Pre-Sales Engineer",
                "Lead Sales Engineer",
                "Manager, Sales Engineering",
                "Director of Sales Engineering"
            ];

            // Initialize levels.fyi fields
            autocomplete(document.getElementById("levelsCompany"), companies);
            autocomplete(document.getElementById("levelsTrack"), jobTracks);

            // Onboarding fields
            if (document.getElementById("onboardRole")) {
                autocomplete(document.getElementById("onboardRole"), roles);
                autocomplete(document.getElementById("onboardLocation"), locations);
                autocomplete(document.getElementById("onboardIndustry"), industries);
                autocomplete(document.getElementById("onboardCompany"), companies);
            }
        }

        // Mode switching
        let currentMode = 'rsu';

        // Legacy function - mode switching now handled by onboarding
        function switchMode(mode) {
            currentMode = mode;
            showCalculator(mode === 'iso' ? 'iso' : 'rsu');
        }

        // Tax Profile Handler
        function updateTaxProfileOptions() {
            const state = document.getElementById('isoState').value;
            const taxProfileSelect = document.getElementById('taxProfile');

            // State tax rate mappings (approximate marginal rates for high earners)
            const stateTaxData = {
                'CA': { name: 'California', highRate: 40, marriedRate: 37 },
                'NY': { name: 'New York', highRate: 39, marriedRate: 36 },
                'NJ': { name: 'New Jersey', highRate: 38, marriedRate: 36 },
                'OR': { name: 'Oregon', highRate: 38, marriedRate: 36 },
                'MA': { name: 'Massachusetts', highRate: 37, marriedRate: 35 },
                'IL': { name: 'Illinois', highRate: 36, marriedRate: 34 },
                'CO': { name: 'Colorado', highRate: 35, marriedRate: 33 },
                'PA': { name: 'Pennsylvania', highRate: 35, marriedRate: 33 },
                'VA': { name: 'Virginia', highRate: 36, marriedRate: 34 },
                'NC': { name: 'North Carolina', highRate: 35, marriedRate: 33 },
                'GA': { name: 'Georgia', highRate: 36, marriedRate: 34 },
                'AZ': { name: 'Arizona', highRate: 35, marriedRate: 33 },
                // No income tax states
                'TX': { name: 'Texas', highRate: 32, marriedRate: 32, noIncomeTax: true },
                'FL': { name: 'Florida', highRate: 32, marriedRate: 32, noIncomeTax: true },
                'WA': { name: 'Washington', highRate: 32, marriedRate: 32, noIncomeTax: true },
                'NV': { name: 'Nevada', highRate: 32, marriedRate: 32, noIncomeTax: true },
                'TN': { name: 'Tennessee', highRate: 32, marriedRate: 32, noIncomeTax: true }
            };

            // Clear existing options
            taxProfileSelect.innerHTML = '<option value="">Select a profile...</option>';

            if (state && stateTaxData[state]) {
                const stateData = stateTaxData[state];

                if (stateData.noIncomeTax) {
                    // No income tax state
                    taxProfileSelect.innerHTML += `<option value="no_tax_${state.toLowerCase()}">${stateData.name} (no state income tax) ‚Üí ${stateData.highRate}%</option>`;
                } else {
                    // State with income tax
                    taxProfileSelect.innerHTML += `<option value="${state.toLowerCase()}_high">Single, ${stateData.name} high earner ‚Üí ${stateData.highRate}%</option>`;
                    taxProfileSelect.innerHTML += `<option value="${state.toLowerCase()}_married">Married, ${stateData.name} ‚Üí ${stateData.marriedRate}%</option>`;
                }
            } else if (state === 'other') {
                // Generic options for other states
                taxProfileSelect.innerHTML += '<option value="other_high">High earner (est. 36%)</option>';
                taxProfileSelect.innerHTML += '<option value="other_moderate">Moderate rate (est. 34%)</option>';
            }

            // Always add custom option
            taxProfileSelect.innerHTML += '<option value="custom">Custom ‚Üí unlocks manual entry</option>';

            // Save state selection
            localStorage.setItem('isoState', state);
        }

        function applyTaxProfile() {
            const state = document.getElementById('isoState').value;
            const taxProfile = document.getElementById('taxProfile').value;
            const marginalTaxRateInput = document.getElementById('marginalTaxRate');

            // Build dynamic tax rates based on state
            const stateTaxData = {
                'CA': { highRate: 40, marriedRate: 37 },
                'NY': { highRate: 39, marriedRate: 36 },
                'NJ': { highRate: 38, marriedRate: 36 },
                'OR': { highRate: 38, marriedRate: 36 },
                'MA': { highRate: 37, marriedRate: 35 },
                'IL': { highRate: 36, marriedRate: 34 },
                'CO': { highRate: 35, marriedRate: 33 },
                'PA': { highRate: 35, marriedRate: 33 },
                'VA': { highRate: 36, marriedRate: 34 },
                'NC': { highRate: 35, marriedRate: 33 },
                'GA': { highRate: 36, marriedRate: 34 },
                'AZ': { highRate: 35, marriedRate: 33 },
                'TX': { highRate: 32, marriedRate: 32 },
                'FL': { highRate: 32, marriedRate: 32 },
                'WA': { highRate: 32, marriedRate: 32 },
                'NV': { highRate: 32, marriedRate: 32 },
                'TN': { highRate: 32, marriedRate: 32 }
            };

            let rate = null;

            if (taxProfile === 'custom') {
                // Enable manual entry for custom
                marginalTaxRateInput.disabled = false;
                marginalTaxRateInput.value = '';
                marginalTaxRateInput.placeholder = 'Enter custom rate';
            } else if (taxProfile === '') {
                // No profile selected
                marginalTaxRateInput.disabled = true;
                marginalTaxRateInput.value = '';
                marginalTaxRateInput.placeholder = '37';
            } else if (taxProfile === 'other_high') {
                rate = 36;
            } else if (taxProfile === 'other_moderate') {
                rate = 34;
            } else if (state && stateTaxData[state]) {
                // Dynamic rate based on state and profile
                if (taxProfile.includes('_high') || taxProfile.includes('no_tax')) {
                    rate = stateTaxData[state].highRate;
                } else if (taxProfile.includes('_married')) {
                    rate = stateTaxData[state].marriedRate;
                }
            }

            if (rate !== null) {
                marginalTaxRateInput.disabled = true;
                marginalTaxRateInput.value = rate;
            }

            // Save to localStorage
            localStorage.setItem('taxProfile', taxProfile);

            // Recalculate
            calculateISO();
        }

        // ISO Calculation
        function calculateISO() {
            // Cash compensation
            const isoBaseSalary = parseFloat(document.getElementById('isoBaseSalary').value) || 0;
            const isoBonusPercent = parseFloat(document.getElementById('isoBonusPercent').value) || 0;
            const isoSignOnBonus = parseFloat(document.getElementById('isoSignOnBonus').value) || 0;

            // ISO values
            const numberOfOptions = parseFloat(document.getElementById('numberOfOptions').value) || 0;
            const strikePrice = parseFloat(document.getElementById('strikePrice').value) || 0;
            const assumedSharePrice = parseFloat(document.getElementById('assumedSharePrice').value) || 0;
            const marginalTaxRate = parseFloat(document.getElementById('marginalTaxRate').value) / 100 || 0;

            // Cost to exercise
            const exerciseCost = strikePrice * numberOfOptions;

            // Gross upside (before tax)
            const grossUpside = (assumedSharePrice - strikePrice) * numberOfOptions;

            // Taxable spread and taxes
            const taxableSpread = grossUpside;
            const estimatedTaxes = taxableSpread * marginalTaxRate;

            // Net upside (after tax)
            const netUpside = grossUpside - estimatedTaxes;

            // ROI multiple
            const roiMultiple = exerciseCost > 0 ? (netUpside / exerciseCost) : 0;

            // Update UI
            document.getElementById('isoExerciseCost').textContent = '$' + exerciseCost.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 });
            document.getElementById('isoGrossUpside').textContent = '$' + grossUpside.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 });
            document.getElementById('isoEstimatedTaxes').textContent = '$' + estimatedTaxes.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 });
            document.getElementById('isoNetUpside').textContent = '$' + netUpside.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 });
            document.getElementById('isoROI').textContent = roiMultiple.toFixed(2) + 'x';

            // Update scenario chart
            updateISOScenarioChart();
        }

        let isoScenarioChart = null;

        // Get chart text color based on dark mode
        function getChartTextColor() {
            return document.body.classList.contains('dark-mode') ? '#e5e5e5' : '#374151';
        }

        function getChartGridColor() {
            return document.body.classList.contains('dark-mode') ? '#404040' : '#d1d5db';
        }

        function updateISOTable(years) {
            const tbody = document.getElementById('isoTableBody');
            if (!tbody) return;

            tbody.innerHTML = '';

            years.forEach(year => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${year.year}</td>
                    <td>$${Math.round(year.baseSalary).toLocaleString()}</td>
                    <td>$${Math.round(year.bonus).toLocaleString()}</td>
                    <td>$${Math.round(year.signOn).toLocaleString()}</td>
                    <td>$${Math.round(year.totalCash).toLocaleString()}</td>
                    <td>$${Math.round(year.isoUpside).toLocaleString()}</td>
                    <td><strong>$${Math.round(year.totalWithISO).toLocaleString()}</strong></td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateISOScenarioChart() {
            // Get inputs
            const isoBaseSalary = parseFloat(document.getElementById('isoBaseSalary').value) || 0;
            const isoBonusPercent = parseFloat(document.getElementById('isoBonusPercent').value) || 0;
            const isoSignOnBonus = parseFloat(document.getElementById('isoSignOnBonus').value) || 0;
            const numberOfOptions = parseFloat(document.getElementById('numberOfOptions').value) || 0;
            const strikePrice = parseFloat(document.getElementById('strikePrice').value) || 0;
            const assumedSharePrice = parseFloat(document.getElementById('assumedSharePrice').value) || 0;
            const marginalTaxRate = parseFloat(document.getElementById('marginalTaxRate').value) / 100 || 0;
            const vestingPeriod = parseFloat(document.getElementById('vestingPeriod').value) || 4;

            // Update slider display and sync
            const scenarioSlider = document.getElementById('scenarioSharePrice');
            const displayElement = document.getElementById('scenarioSharePriceDisplay');
            if (displayElement) {
                displayElement.textContent = assumedSharePrice.toFixed(2);
            }

            // Set intelligent slider range: from strike price to 3x assumed price (or 3x strike if no assumed)
            if (scenarioSlider && !scenarioSlider.matches(':active')) {
                const minPrice = strikePrice || 0;
                const maxPrice = assumedSharePrice > 0
                    ? Math.max(assumedSharePrice * 3, strikePrice * 3)
                    : (strikePrice > 0 ? strikePrice * 3 : 500);

                scenarioSlider.min = minPrice;
                scenarioSlider.max = maxPrice;
                scenarioSlider.value = assumedSharePrice || strikePrice;

                // Update labels
                document.getElementById('sliderMinLabel').textContent = '$' + minPrice.toFixed(0);
                document.getElementById('sliderMaxLabel').textContent = '$' + maxPrice.toFixed(0);
            }

            // Calculate annualized ISO upside
            const grossUpside = (assumedSharePrice - strikePrice) * numberOfOptions;
            const estimatedTaxes = grossUpside * marginalTaxRate;
            const netUpside = grossUpside - estimatedTaxes;
            const annualizedISOUpside = vestingPeriod > 0 ? netUpside / vestingPeriod : 0;

            // Calculate cash comp per year (with optional 3% raise)
            const enableISOAnnualRaise = document.getElementById('enableISOAnnualRaise').checked;
            const annualRaiseMultiplier = enableISOAnnualRaise ? 1.03 : 1;

            const years = [];
            for (let i = 0; i < 4; i++) {
                const currentBaseSalary = isoBaseSalary * Math.pow(annualRaiseMultiplier, i);
                const bonus = currentBaseSalary * (isoBonusPercent / 100);
                const signOn = i === 0 ? isoSignOnBonus : 0;
                const totalCash = currentBaseSalary + bonus + signOn;
                const totalWithISO = totalCash + annualizedISOUpside;

                years.push({
                    year: `Year ${i + 1}`,
                    baseSalary: currentBaseSalary,
                    bonus: bonus,
                    signOn: signOn,
                    totalCash: totalCash,
                    isoUpside: annualizedISOUpside,
                    totalWithISO: totalWithISO,
                    guaranteed: totalCash  // For chart compatibility
                });
            }

            // Update table
            updateISOTable(years);

            // Create or update chart
            const ctx = document.getElementById('isoScenarioChart');
            if (!ctx) return;

            if (isoScenarioChart) {
                // Update existing chart data
                isoScenarioChart.data.datasets[0].data = years.map(y => y.guaranteed);
                isoScenarioChart.data.datasets[1].data = years.map(y => y.totalWithISO);
                isoScenarioChart.update('none'); // 'none' = no animation for smooth slider
            } else {
                // Create new chart
                isoScenarioChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: years.map(y => y.year),
                        datasets: [
                            {
                                label: 'Base Only (Guaranteed)',
                                data: years.map(y => y.guaranteed),
                                backgroundColor: '#8feeff',
                            },
                            {
                                label: 'Base + ISO Upside',
                                data: years.map(y => y.totalWithISO),
                                backgroundColor: '#ff630f',
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        animation: {
                            duration: 0 // Disable animation for smoother updates
                        },
                        scales: {
                            x: {
                                stacked: false,
                                ticks: {
                                    color: getChartTextColor()
                                },
                                grid: {
                                    color: getChartGridColor()
                                }
                            },
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    color: getChartTextColor(),
                                    callback: function (value) {
                                        return '$' + (value / 1000).toFixed(0) + 'k';
                                    }
                                },
                                grid: {
                                    color: getChartGridColor()
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        return context.dataset.label + ': $' + context.parsed.y.toLocaleString();
                                    }
                                }
                            },
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    color: getChartTextColor()
                                }
                            }
                        }
                    }
                });
            }
        }

        // Add event listeners for ISO inputs
        document.addEventListener('DOMContentLoaded', function () {
            const isoInputs = ['isoBaseSalary', 'isoBonusPercent', 'isoSignOnBonus', 'numberOfOptions', 'strikePrice', 'assumedSharePrice', 'marginalTaxRate', 'vestingPeriod', 'isoState', 'enableISOAnnualRaise'];
            isoInputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', calculateISO);
                    // Save to localStorage
                    element.addEventListener('change', function () {
                        localStorage.setItem(id, this.value);
                    });
                    // Load from localStorage
                    const savedValue = localStorage.getItem(id);
                    if (savedValue) {
                        element.value = savedValue;
                    }
                }
            });

            // Add event listener for scenario share price slider
            const scenarioSlider = document.getElementById('scenarioSharePrice');
            const assumedSharePriceInput = document.getElementById('assumedSharePrice');

            if (scenarioSlider && assumedSharePriceInput) {
                // Slider updates assumed share price and chart
                scenarioSlider.addEventListener('input', function () {
                    assumedSharePriceInput.value = this.value;
                    document.getElementById('scenarioSharePriceDisplay').textContent = parseFloat(this.value).toFixed(2);
                    // Only update chart, not full calculation (for smoothness)
                    updateISOScenarioChart();
                });

                // Save to localStorage on slider release
                scenarioSlider.addEventListener('change', function () {
                    localStorage.setItem('assumedSharePrice', this.value);
                    calculateISO(); // Full recalc on release
                });

                // Assumed share price input updates slider and its range
                assumedSharePriceInput.addEventListener('input', function () {
                    const strikePrice = parseFloat(document.getElementById('strikePrice').value) || 0;
                    const assumedPrice = parseFloat(this.value) || 0;

                    // Update slider range dynamically
                    scenarioSlider.min = strikePrice || 0;
                    scenarioSlider.max = assumedPrice > 0
                        ? Math.max(assumedPrice * 3, strikePrice * 3)
                        : (strikePrice > 0 ? strikePrice * 3 : 500);
                    scenarioSlider.value = this.value;

                    // Update labels
                    document.getElementById('sliderMinLabel').textContent = '$' + scenarioSlider.min;
                    document.getElementById('sliderMaxLabel').textContent = '$' + Math.round(scenarioSlider.max);
                    document.getElementById('scenarioSharePriceDisplay').textContent = parseFloat(this.value || 0).toFixed(2);
                });
            }

            // Load saved state and tax profile, or use defaults
            const savedState = localStorage.getItem('isoState');
            if (savedState) {
                document.getElementById('isoState').value = savedState;
                updateTaxProfileOptions();
            } else {
                // On first load, CA is already selected by default, so update options
                updateTaxProfileOptions();
            }

            const savedTaxProfile = localStorage.getItem('taxProfile');
            if (savedTaxProfile) {
                document.getElementById('taxProfile').value = savedTaxProfile;
                applyTaxProfile();
            }

            // Load saved mode
            const savedMode = localStorage.getItem('calculatorMode') || 'rsu';
            switchMode(savedMode);
        });

        // Copy/Download chart as PNG
        function copyChartToClipboard(chartId) {
            const canvas = document.getElementById(chartId);

            // Convert canvas to blob and try clipboard API first
            canvas.toBlob(async (blob) => {
                let success = false;

                // Try Clipboard API (works in some browsers)
                if (navigator.clipboard && ClipboardItem) {
                    try {
                        await navigator.clipboard.write([
                            new ClipboardItem({
                                'image/png': blob
                            })
                        ]);
                        success = true;
                        showChartCopyFeedback(chartId, 'Chart copied to clipboard!');
                    } catch (err) {
                        // Clipboard API failed, fall through to download
                        console.log('Clipboard API not supported, downloading instead');
                    }
                }

                // Fallback: Download the image
                if (!success) {
                    const url = canvas.toDataURL('image/png');
                    const link = document.createElement('a');
                    link.download = 'compensation-breakdown.png';
                    link.href = url;
                    link.click();
                    showChartCopyFeedback(chartId, 'Chart downloaded!');
                }
            }, 'image/png');
        }

        function showChartCopyFeedback(chartId, message) {
            const canvas = document.getElementById(chartId);
            const container = canvas.parentElement;

            // Create feedback overlay
            const feedback = document.createElement('div');
            feedback.textContent = '‚úì ' + message;
            feedback.style.position = 'absolute';
            feedback.style.top = '50%';
            feedback.style.left = '50%';
            feedback.style.transform = 'translate(-50%, -50%)';
            feedback.style.background = '#10b981';
            feedback.style.color = 'white';
            feedback.style.padding = '12px 24px';
            feedback.style.borderRadius = '8px';
            feedback.style.fontSize = '1rem';
            feedback.style.fontWeight = '600';
            feedback.style.zIndex = '1000';
            feedback.style.pointerEvents = 'none';

            container.style.position = 'relative';
            container.appendChild(feedback);

            setTimeout(() => {
                feedback.remove();
            }, 2000);
        }

        // Dark mode functionality
        function initDarkMode() {
            // Check for saved preference, default to dark mode
            const savedMode = localStorage.getItem('darkMode');

            // If no saved preference, default to dark mode
            // If saved preference exists, use that
            if (savedMode === 'dark' || savedMode === null) {
                document.body.classList.add('dark-mode');
                updateDarkModeIcon(true);
            } else {
                updateDarkModeIcon(false);
            }
        }

        function toggleDarkMode() {
            const isDark = document.body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', isDark ? 'dark' : 'light');
            updateDarkModeIcon(isDark);

            // Refresh charts to update colors
            if (currentMode === 'rsu') {
                if (typeof updateDisplay === 'function') {
                    updateDisplay();
                }
            } else if (currentMode === 'iso') {
                if (typeof calculateISO === 'function') {
                    calculateISO();
                }
            }
        }

        function updateDarkModeIcon(isDark) {
            const icon = document.getElementById('darkModeIcon');
            icon.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
        }

        // Initialize dark mode on page load
        initDarkMode();

        // Copy to clipboard function
        function copyToClipboard(element) {
            const text = element.textContent.trim();

            // Try modern clipboard API first
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => {
                    showCopyFeedback(element);
                }).catch(() => {
                    // Fallback for mobile or older browsers
                    fallbackCopy(text, element);
                });
            } else {
                // Fallback for older browsers
                fallbackCopy(text, element);
            }
        }

        function fallbackCopy(text, element) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            textarea.setSelectionRange(0, 99999); // For mobile

            try {
                document.execCommand('copy');
                showCopyFeedback(element);
            } catch (err) {
                console.error('Copy failed:', err);
            }

            document.body.removeChild(textarea);
        }

        function showCopyFeedback(element) {
            const originalText = element.textContent;
            element.textContent = '‚úì Copied!';
            element.style.color = '#10b981';

            setTimeout(() => {
                element.textContent = originalText;
                element.style.color = '';
            }, 1500);
        }

        function resetCalculator() {
            if (confirm('Are you sure you want to reset all calculator values to defaults? This will not affect your profile information.')) {
                // Preserve onboarding data
                const onboardingCompleted = localStorage.getItem('onboardingCompleted');
                const onboardingData = localStorage.getItem('onboardingData');

                localStorage.removeItem('databricksCompCalc');

                // Restore onboarding data
                if (onboardingCompleted) localStorage.setItem('onboardingCompleted', onboardingCompleted);
                if (onboardingData) localStorage.setItem('onboardingData', onboardingData);

                location.reload();
            }
        }

        function getVestingSchedule() {
            const scheduleType = document.getElementById('vestingSchedule').value;
            if (scheduleType === 'front') {
                return [0.40, 0.30, 0.20, 0.10];
            } else {
                return [0.25, 0.25, 0.25, 0.25];
            }
        }

        // 2026 Federal tax brackets and standard deductions
        const taxData2026 = {
            single: {
                standardDeduction: 15000,
                brackets: [
                    { rate: 0.10, limit: 11925 },
                    { rate: 0.12, limit: 48475 },
                    { rate: 0.22, limit: 103350 },
                    { rate: 0.24, limit: 197300 },
                    { rate: 0.32, limit: 250525 },
                    { rate: 0.35, limit: 626350 },
                    { rate: 0.37, limit: Infinity }
                ]
            },
            married: {
                standardDeduction: 30000,
                brackets: [
                    { rate: 0.10, limit: 23850 },
                    { rate: 0.12, limit: 96950 },
                    { rate: 0.22, limit: 206700 },
                    { rate: 0.24, limit: 394600 },
                    { rate: 0.32, limit: 501050 },
                    { rate: 0.35, limit: 751600 },
                    { rate: 0.37, limit: Infinity }
                ]
            },
            head: {
                standardDeduction: 22500,
                brackets: [
                    { rate: 0.10, limit: 17000 },
                    { rate: 0.12, limit: 64850 },
                    { rate: 0.22, limit: 103350 },
                    { rate: 0.24, limit: 197300 },
                    { rate: 0.32, limit: 250500 },
                    { rate: 0.35, limit: 626350 },
                    { rate: 0.37, limit: Infinity }
                ]
            }
        };

        // Calculate progressive federal tax
        function calculateProgressiveFederalTax(grossIncome, filingStatus) {
            const statusData = taxData2026[filingStatus];
            const standardDeduction = statusData.standardDeduction;
            const brackets = statusData.brackets;

            // Apply standard deduction
            const taxableIncome = Math.max(0, grossIncome - standardDeduction);

            if (taxableIncome <= 0) {
                return 0;
            }

            let totalTax = 0;
            let previousLimit = 0;

            for (let i = 0; i < brackets.length; i++) {
                const bracket = brackets[i];
                const bracketLimit = bracket.limit;

                if (taxableIncome > previousLimit) {
                    const taxableInBracket = Math.min(taxableIncome, bracketLimit) - previousLimit;
                    totalTax += taxableInBracket * bracket.rate;

                    if (taxableIncome <= bracketLimit) {
                        break;
                    }
                }

                previousLimit = bracketLimit;
            }

            return totalTax;
        }

        let stackedChart;

        // Save inputs to localStorage
        function saveInputs() {
            const inputs = [
                'baseSalary', 'bonusPercent', 'signOnBonus',
                'stockYear1', 'stockYear2', 'stockYear3', 'stockYear4', 'stockGrowth',
                'initialGrant', 'vestingSchedule', 'refresherYear2', 'refresherYear3', 'refresherYear4', 'refresherVesting',
                'filingStatus', 'stateTaxRate', 'ficaTaxRate'
            ];

            const values = {};
            inputs.forEach(id => {
                const element = document.getElementById(id);
                values[id] = element.value;
            });

            // Handle checkbox separately
            values['enableTax'] = document.getElementById('enableTax').checked;
            values['enableRefreshers'] = document.getElementById('enableRefreshers').checked;
            values['enableAnnualRaise'] = document.getElementById('enableAnnualRaise').checked;

            // Save Select2 dropdowns (company and job track)
            values['levelsCompany'] = $('#levelsCompany').val();
            values['levelsTrack'] = $('#levelsTrack').val();

            localStorage.setItem('databricksCompCalc', JSON.stringify(values));
        }

        // Load inputs from localStorage
        function loadInputs() {
            const saved = localStorage.getItem('databricksCompCalc');
            if (saved) {
                try {
                    const values = JSON.parse(saved);
                    Object.keys(values).forEach(id => {
                        const element = document.getElementById(id);
                        if (element) {
                            if (id === 'enableTax' || id === 'enableRefreshers' || id === 'enableAnnualRaise') {
                                element.checked = values[id];
                            } else {
                                element.value = values[id];
                            }
                        }
                    });

                    // Show/hide refreshers inputs based on saved state
                    const refreshersInputs = document.getElementById('refreshersInputs');
                    if (values['enableRefreshers']) {
                        refreshersInputs.style.display = 'block';
                    }

                    // Load Select2 values if they exist
                    if (values['levelsCompany']) {
                        $('#levelsCompany').val(values['levelsCompany']);
                    }
                    if (values['levelsTrack']) {
                        $('#levelsTrack').val(values['levelsTrack']);
                    }
                } catch (e) {
                    console.error('Error loading saved data:', e);
                }
            }
        }

        function formatCurrency(value) {
            return '$' + Math.round(value).toLocaleString();
        }

        function calculateComp() {
            const baseSalary = parseInt(document.getElementById('baseSalary').value) || 0;
            const bonusPercent = parseFloat(document.getElementById('bonusPercent').value) || 0;
            const signOnBonus = parseInt(document.getElementById('signOnBonus').value) || 0;

            // Check which mode we're in and use the appropriate checkbox
            const isCommissionMode = onboardingData.cashType === 'commission';
            const enableAnnualRaise = isCommissionMode ?
                document.getElementById('enableAnnualRaiseComm').checked :
                document.getElementById('enableAnnualRaise').checked;
            const annualRaise = enableAnnualRaise ? 0.03 : 0; // 3% if enabled, 0% if not

            const initialGrant = parseFloat(document.getElementById('initialGrant').value) || 0;
            const vestingSchedule = getVestingSchedule();

            const stockPrices = [
                parseFloat(document.getElementById('stockYear1').value) || 0,
                parseFloat(document.getElementById('stockYear2').value) || 0,
                parseFloat(document.getElementById('stockYear3').value) || 0,
                parseFloat(document.getElementById('stockYear4').value) || 0
            ];

            const enableRefreshers = document.getElementById('enableRefreshers').checked;
            const refresherGrants = enableRefreshers ? [
                0, // Year 1 - no refresher
                parseFloat(document.getElementById('refresherYear2').value) || 0,
                parseFloat(document.getElementById('refresherYear3').value) || 0,
                parseFloat(document.getElementById('refresherYear4').value) || 0
            ] : [0, 0, 0, 0];

            const refresherVestingPercent = enableRefreshers ? (parseFloat(document.getElementById('refresherVesting').value) / 100 || 0) : 0;

            // Tax calculation
            const enableTax = document.getElementById('enableTax').checked;
            const filingStatus = document.getElementById('filingStatus').value;
            const stateTaxRate = parseFloat(document.getElementById('stateTaxRate').value) / 100 || 0;
            const ficaTaxRate = parseFloat(document.getElementById('ficaTaxRate').value) / 100 || 0;

            const years = [];

            for (let i = 0; i < 4; i++) {
                const currentBaseSalary = baseSalary * Math.pow(1 + annualRaise, i);
                const bonus = currentBaseSalary * (bonusPercent / 100);
                // Add sign-on bonus only in Year 1
                const signOn = (i === 0) ? signOnBonus : 0;

                // Initial grant vesting
                const initialSharesVested = initialGrant * vestingSchedule[i];

                // Refresher vesting - each refresher vests over time
                let refresherSharesVested = 0;

                // Year 2: only year 2 refresher vests (first year)
                // Year 3: year 2 refresher (2nd year) + year 3 refresher (1st year)
                // Year 4: year 2 refresher (3rd year) + year 3 refresher (2nd year) + year 4 refresher (1st year)
                if (i >= 1) { // Year 2+
                    refresherSharesVested += refresherGrants[i] * refresherVestingPercent; // Current year's refresher
                }
                if (i >= 2) { // Year 3+
                    refresherSharesVested += refresherGrants[i - 1] * refresherVestingPercent; // Last year's refresher
                }
                if (i >= 3) { // Year 4
                    refresherSharesVested += refresherGrants[i - 2] * refresherVestingPercent; // 2 years ago refresher
                }

                const totalSharesVested = initialSharesVested + refresherSharesVested;
                const stockValue = totalSharesVested * stockPrices[i];
                const totalComp = currentBaseSalary + bonus + signOn + stockValue;

                // Calculate progressive taxes
                let afterTaxComp = totalComp;
                if (enableTax) {
                    const federalTax = calculateProgressiveFederalTax(totalComp, filingStatus);
                    const stateTax = totalComp * stateTaxRate;
                    const ficaTax = totalComp * ficaTaxRate;
                    const totalTax = federalTax + stateTax + ficaTax;
                    afterTaxComp = Math.round(totalComp - totalTax);
                }

                years.push({
                    year: i + 1,
                    baseSalary: Math.round(currentBaseSalary),
                    bonus: Math.round(bonus),
                    signOnBonus: Math.round(signOn),
                    initialSharesVested: Math.round(initialSharesVested),
                    refresherSharesVested: Math.round(refresherSharesVested),
                    stockPrice: stockPrices[i],
                    stockValue: Math.round(stockValue),
                    totalComp: Math.round(totalComp),
                    afterTaxComp: afterTaxComp
                });
            }

            return years;
        }

        function updateDisplay() {
            const data = calculateComp();
            const enableTax = document.getElementById('enableTax').checked;

            // Update summary cards
            document.getElementById('year1Total').textContent = formatCurrency(data[0].totalComp);
            document.getElementById('year4Total').textContent = formatCurrency(data[3].totalComp);

            const fourYearTotal = data.reduce((sum, year) => sum + year.totalComp, 0);
            document.getElementById('fourYearTotal').textContent = formatCurrency(fourYearTotal);
            document.getElementById('avgAnnual').textContent = formatCurrency(fourYearTotal / 4);

            // Show/hide after-tax values in summary cards
            if (enableTax) {
                document.getElementById('year1TotalAfterTax').textContent = 'After tax: ' + formatCurrency(data[0].afterTaxComp);
                document.getElementById('year4TotalAfterTax').textContent = 'After tax: ' + formatCurrency(data[3].afterTaxComp);
                const fourYearAfterTax = data.reduce((sum, year) => sum + year.afterTaxComp, 0);
                document.getElementById('fourYearTotalAfterTax').textContent = 'After tax: ' + formatCurrency(fourYearAfterTax);
                document.getElementById('avgAnnualAfterTax').textContent = 'After tax: ' + formatCurrency(fourYearAfterTax / 4);
            } else {
                document.getElementById('year1TotalAfterTax').textContent = '';
                document.getElementById('year4TotalAfterTax').textContent = '';
                document.getElementById('fourYearTotalAfterTax').textContent = '';
                document.getElementById('avgAnnualAfterTax').textContent = '';
            }

            // Show/hide after-tax column in table
            const afterTaxHeader = document.getElementById('afterTaxHeader');
            afterTaxHeader.style.display = enableTax ? '' : 'none';

            // Update table
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = data.map(row => `
                <tr>
                    <td>Year ${row.year}</td>
                    <td class="text-right">${formatCurrency(row.baseSalary)}</td>
                    <td class="text-right">${formatCurrency(row.bonus)}</td>
                    <td class="text-right">${row.signOnBonus > 0 ? formatCurrency(row.signOnBonus) : '-'}</td>
                    <td class="text-right">${row.initialSharesVested}</td>
                    <td class="text-right">${row.refresherSharesVested}</td>
                    <td class="text-right">$${row.stockPrice}</td>
                    <td class="text-right">${formatCurrency(row.stockValue)}</td>
                    <td class="text-right"><strong>${formatCurrency(row.totalComp)}</strong></td>
                    ${enableTax ? `<td class="text-right"><strong>${formatCurrency(row.afterTaxComp)}</strong></td>` : ''}
                </tr>
            `).join('');

            // Update charts
            updateCharts(data);
        }

        function updateCharts(data) {
            const labels = data.map(d => `Year ${d.year}`);
            const enableTax = document.getElementById('enableTax').checked;

            // Stacked Bar Chart
            if (stackedChart) stackedChart.destroy();
            const stackedCtx = document.getElementById('stackedChart').getContext('2d');

            const datasets = [
                {
                    label: 'Base Salary',
                    data: data.map(d => d.baseSalary),
                    backgroundColor: '#8feeff',
                    stack: 'pre-tax'
                },
                {
                    label: 'Target Variable',
                    data: data.map(d => d.bonus),
                    backgroundColor: '#ffd700',
                    stack: 'pre-tax'
                },
                {
                    label: 'Stock Value',
                    data: data.map(d => d.stockValue),
                    backgroundColor: '#ff630f',
                    stack: 'pre-tax'
                }
            ];

            // Add after-tax bar as separate grouped bar if tax is enabled
            if (enableTax) {
                datasets.push({
                    label: 'After Tax',
                    data: data.map(d => d.afterTaxComp),
                    backgroundColor: '#a78bfa',
                    stack: 'after-tax'
                });
            }

            stackedChart = new Chart(stackedCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        x: {
                            stacked: false,
                            ticks: {
                                color: getChartTextColor()
                            },
                            grid: {
                                color: getChartGridColor()
                            }
                        },
                        y: {
                            stacked: true,
                            ticks: {
                                color: getChartTextColor(),
                                callback: function (value) {
                                    return '$' + (value / 1000).toFixed(0) + 'k';
                                }
                            },
                            grid: {
                                color: getChartGridColor()
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return context.dataset.label + ': $' + context.parsed.y.toLocaleString();
                                }
                            }
                        },
                        legend: {
                            labels: {
                                color: getChartTextColor()
                            }
                        }
                    }
                }
            });
        }

        // Update display values as inputs change
        function setupInputListeners() {
            const inputs = [
                'baseSalary', 'bonusPercent', 'signOnBonus',
                'initialGrant', 'vestingSchedule', 'refresherYear2', 'refresherYear3', 'refresherYear4', 'refresherVesting',
                'enableTax', 'filingStatus', 'stateTaxRate', 'ficaTaxRate', 'enableRefreshers', 'enableAnnualRaise'
            ];

            inputs.forEach(id => {
                const element = document.getElementById(id);
                element.addEventListener('input', function () {
                    saveInputs();
                    updateDisplay();
                });
            });

            // Toggle refreshers inputs visibility
            const enableRefreshersCheckbox = document.getElementById('enableRefreshers');
            const refreshersInputs = document.getElementById('refreshersInputs');

            enableRefreshersCheckbox.addEventListener('change', function () {
                refreshersInputs.style.display = this.checked ? 'block' : 'none';
                saveInputs();
                updateDisplay();
            });

            // Special handling for stock inputs
            const stockInputs = ['stockYear1', 'stockYear2', 'stockYear3', 'stockYear4'];
            stockInputs.forEach(id => {
                const element = document.getElementById(id);
                element.addEventListener('input', function () {
                    saveInputs();
                    updateDisplay();
                });
            });

            // Special handling for stock growth - auto-calculate Years 2-4
            const stockGrowthInput = document.getElementById('stockGrowth');
            const stockYear1Input = document.getElementById('stockYear1');

            function applyStockGrowth() {
                const year1Price = parseFloat(stockYear1Input.value) || 0;
                const growthPercent = parseFloat(stockGrowthInput.value) || 0;
                const growthMultiplier = 1 + (growthPercent / 100);

                // Only auto-update if growth is not zero
                if (growthPercent !== 0) {
                    document.getElementById('stockYear2').value = Math.round(year1Price * growthMultiplier);
                    document.getElementById('stockYear3').value = Math.round(year1Price * Math.pow(growthMultiplier, 2));
                    document.getElementById('stockYear4').value = Math.round(year1Price * Math.pow(growthMultiplier, 3));
                    saveInputs();
                    updateDisplay();
                }
            }

            stockGrowthInput.addEventListener('input', function () {
                applyStockGrowth();
                saveInputs();
            });
        }

        // Toggle collapsible sections
        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            const icon = document.getElementById(sectionId.replace('Section', 'Icon'));

            section.classList.toggle('collapsed');
            icon.classList.toggle('collapsed');
        }

        // Update levels.fyi iframe based on dropdown selections
        function updateLevelsIframe() {
            const company = document.getElementById('levelsCompany').value;
            const track = document.getElementById('levelsTrack').value;
            const iframe = document.getElementById('levelsIframe');

            // URL encode the track parameter
            const encodedTrack = encodeURIComponent(track);

            iframe.src = `https://www.levels.fyi/charts_embed.html?company=${company}&track=${encodedTrack}&hide_selector=true`;
        }

        // Initialize
        loadInputs();
        setupInputListeners();
        setupOTEListeners();

        // Check onboarding status first
        checkOnboardingStatus();

        // Initialize AI Analyzer inputs and load saved values
        setupAIInputListeners();
        initializeAutocomplete();
        loadAIInputs();

        // Add event listeners for levels.fyi company and track inputs
        document.getElementById('levelsCompany').addEventListener('input', function () {
            updateLevelsIframe();
            saveInputs();
        });

        document.getElementById('levelsTrack').addEventListener('input', function () {
            updateLevelsIframe();
            saveInputs();
        });

        // Set default values
        document.getElementById('levelsCompany').value = 'Meta';
        document.getElementById('levelsTrack').value = 'Software Engineer';
        updateLevelsIframe();


        updateDisplay();
    </script>
</body>

</html>