<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>comp.fyi</title>
    <link rel="manifest" href="/manifest.webmanifest">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <!-- Select2 for searchable dropdowns -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;1,100;1,200;1,300;1,400;1,500;1,600;1,700&family=Instrument+Sans:ital,wght@0,400..700;1,400..700&family=Syne:wght@400..800&display=swap" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'mono': ['"IBM Plex Mono"', 'monospace'],
                        'syne': ['"Syne"', 'sans-serif'],
                        'instrument': ['"Instrument Sans"', 'sans-serif']
                    }
                }
            }
        }
        
        // Suppress Tailwind CDN warning
        if (typeof window !== 'undefined') {
            const originalWarn = console.warn;
            console.warn = function(...args) {
                if (args[0]?.includes?.('cdn.tailwindcss.com')) return;
                originalWarn.apply(console, args);
            };
        }
    </script>
    <style>
        /* Dark mode variables */
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #e5fbf8;
            --bg-card: #ffffff;
            --text-primary: #1f2937;
            --text-secondary: #57534e;
            --border-color: #e5e7eb;
            --border-color-focus: #3b82f6;
        }

        body.dark-mode {
            --bg-primary: #0a0a0a;
            --bg-secondary: #1a1a1a;
            --bg-card: #171717;
            --text-primary: #e5e5e5;
            --text-secondary: #a3a3a3;
            --border-color: #404040;
            --border-color-focus: #8feeff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "IBM Plex Mono", monospace;
            background: var(--bg-primary);
            color: var(--text-primary);
            padding: 20px;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px;
        }

        h1, h2 {
            color: var(--text-primary);
        }

        h1 {
            margin-bottom: 30px;
            font-size: 2rem;
        }

        h2 {
            margin-bottom: 20px;
            font-size: 1.25rem;
        }

        .inputs-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .inputs-grid-three {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .inputs-grid-four {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .input-section {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group:last-child {
            margin-bottom: 0;
        }

        label {
            display: block;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        input[type="number"], select {
            width: 100%;
            padding: 10px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            font-size: 0.95rem;
            transition: border-color 0.2s, background-color 0.3s ease, color 0.3s ease;
            background: var(--bg-card);
            color: var(--text-primary);
        }

        input[type="number"]:focus, select:focus {
            outline: none;
            border-color: var(--border-color-focus);
        }

        /* Select2 custom styling */
        .select2-container--default .select2-selection--single {
            height: 44px;
            border: 2px solid #d1d5db;
            border-radius: 6px;
        }

        .select2-container--default .select2-selection--single .select2-selection__rendered {
            line-height: 40px;
            padding-left: 10px;
            font-size: 0.95rem;
        }

        .select2-container--default .select2-selection--single .select2-selection__arrow {
            height: 42px;
        }

        .select2-container--default.select2-container--focus .select2-selection--single {
            border-color: #3b82f6;
        }

        .select2-dropdown {
            border: 2px solid #d1d5db;
            border-radius: 6px;
        }

        .select2-search--dropdown .select2-search__field {
            border: 2px solid #d1d5db;
            border-radius: 6px;
            padding: 8px;
        }

        .select2-container {
            width: 100% !important;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border: 2px solid var(--border-color);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .summary-label {
            font-size: 0.85rem;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .summary-value {
            font-size: 1.75rem;
            font-weight: bold;
        }

        .summary-card:nth-child(1) .summary-value {
            color: #3b82f6;
        }

        .summary-card:nth-child(2) .summary-value {
            color: #10b981;
        }

        .summary-card:nth-child(3) .summary-value {
            color: #8b5cf6;
        }

        .summary-card:nth-child(4) .summary-value {
            color: #f59e0b;
        }

        .chart-container {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            border: 1px solid var(--border-color);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        canvas {
            max-height: 400px;
        }

        table {
            width: 100%;
            min-width: 700px;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 0.9rem;
        }

        th {
            background: var(--bg-secondary);
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: var(--text-primary);
            border-bottom: 2px solid var(--border-color);
        }

        td {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        tr:hover {
            background: var(--bg-secondary);
        }

        .text-right {
            text-align: right;
        }

        .note {
            background: #dbeafe;
            border: 1px solid #93c5fd;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            color: #1e40af;
            font-size: 0.9rem;
        }

        body.dark-mode .note {
            background: #1e293b;
            border-color: #334155;
            color: #8feeff;
        }

        .note strong {
            color: #1e3a8a;
        }

        body.dark-mode .note strong {
            color: #8feeff;
        }

        /* Override hardcoded paragraph colors in dark mode with slightly darker text for contrast */
        body.dark-mode p {
            color: #a3a3a3 !important;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
            padding: 5px 0;
        }

        .section-header:hover h2 {
            color: #8feeff;
        }

        .collapse-icon {
            font-size: 1.5rem;
            color: var(--text-secondary);
            transition: transform 0.3s ease;
        }

        /* Dark mode Select2 styles */
        body.dark-mode .select2-container--default .select2-selection--single {
            background: var(--bg-card);
            border-color: var(--border-color);
        }

        body.dark-mode .select2-container--default .select2-selection--single .select2-selection__rendered {
            color: #e5e5e5 !important;
        }

        body.dark-mode .select2-container--default .select2-selection--single .select2-selection__arrow b {
            border-color: var(--text-secondary) transparent transparent transparent;
        }

        body.dark-mode .select2-dropdown {
            background: var(--bg-card);
            border-color: var(--border-color);
        }

        body.dark-mode .select2-results__option {
            background: var(--bg-card);
            color: #e5e5e5 !important;
        }

        body.dark-mode .select2-results__option--highlighted[aria-selected] {
            background: var(--bg-secondary) !important;
            color: #e5e5e5 !important;
        }

        body.dark-mode .select2-search--dropdown .select2-search__field {
            background: var(--bg-card);
            color: #e5e5e5 !important;
            border-color: var(--border-color);
        }

        body.dark-mode .select2-container--default .select2-results__option[aria-selected=true] {
            background: var(--bg-secondary);
            color: #e5e5e5 !important;
        }

        .collapse-icon.collapsed {
            transform: rotate(-90deg);
        }

        .collapsible-content {
            max-height: 2000px;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .collapsible-content.collapsed {
            max-height: 0;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }

            h1 {
                font-size: 1.5rem;
            }
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body class="font-mono antialiased p-5 min-h-screen">
    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
            <div>
                <h1 class="font-instrument font-bold" style="margin: 0; font-size: 24px;">comp.fyi</h1>
                <p class="font-mono" style="margin: 5px 0 0 0; font-size: 0.9rem; color: #ff630f !important;">By Anmol Thiara</p>
            </div>
            <div style="display: flex; gap: 10px;">
                <button id="darkModeToggle" onclick="toggleDarkMode()"
                    style="padding: 8px 16px; background: #333231; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem; font-weight: 500;">
                    <span id="darkModeIcon">ðŸŒ™</span>
                </button>
                <button onclick="resetCalculator()"
                    style="padding: 8px 16px; background: #ff630f; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem; font-weight: 500;">
                    Reset to Defaults
                </button>
            </div>
        </div>

        <!-- Mode Toggle -->
        <div style="display: flex; justify-content: center; margin-bottom: 30px;">
            <div style="background: var(--bg-secondary); border-radius: 8px; padding: 4px; display: inline-flex; gap: 4px;">
                <button id="rsuModeBtn" onclick="switchMode('rsu')"
                    style="padding: 10px 24px; background: #8feeff; color: #0a0a0a; border: none; border-radius: 6px; cursor: pointer; font-size: 0.95rem; font-weight: 600; transition: all 0.2s;">
                    RSU Calculator
                </button>
                <button id="isoModeBtn" onclick="switchMode('iso')"
                    style="padding: 10px 24px; background: transparent; color: var(--text-primary); border: none; border-radius: 6px; cursor: pointer; font-size: 0.95rem; font-weight: 600; transition: all 0.2s;">
                    ISO Calculator
                </button>
            </div>
        </div>

        <!-- RSU Calculator Content -->
        <div id="rsuCalculator">
        <div class="inputs-grid-four">
            <!-- Cash Compensation -->
            <div class="input-section">
                <div class="section-header" onclick="toggleSection('cashCompSection')">
                    <h2>Cash Compensation</h2>
                    <span class="collapse-icon" id="cashCompIcon">â–¼</span>
                </div>
                <div class="collapsible-content" id="cashCompSection">
                    <p style="font-size: 0.85rem; color: #57534e; margin-bottom: 15px;">Auto-applies 3% annual raise
                        each year</p>

                    <div class="input-group">
                        <label for="baseSalary">Starting Base Salary ($)</label>
                        <input type="number" id="baseSalary" min="0" step="1000" placeholder="0">
                    </div>

                    <div class="input-group">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="enableAnnualRaise" checked style="width: auto; margin-right: 10px; cursor: pointer;">
                            <span>Apply 3% annual raise</span>
                        </label>
                    </div>

                    <div class="input-group">
                        <label for="bonusPercent">Annual Bonus (%)</label>
                        <input type="number" id="bonusPercent" min="0" max="100" step="0.5" placeholder="0">
                        <p style="font-size: 0.75rem; color: #57534e; margin-top: 5px;">Applied to base salary each year
                        </p>
                    </div>

                    <div class="input-group">
                        <label for="signOnBonus">Sign-On Bonus ($)</label>
                        <input type="number" id="signOnBonus" min="0" step="1000" placeholder="0">
                        <p style="font-size: 0.75rem; color: #57534e; margin-top: 5px;">One-time payment in Year 1</p>
                    </div>
                </div>
            </div>

            <!-- RSU Grants -->
            <div class="input-section">
                <div class="section-header" onclick="toggleSection('rsuGrantsSection')">
                    <h2>RSU Grants</h2>
                    <span class="collapse-icon" id="rsuGrantsIcon">â–¼</span>
                </div>
                <div class="collapsible-content" id="rsuGrantsSection">
                    <div class="input-group">
                        <label for="initialGrant">Initial Grant (RSUs)</label>
                        <input type="number" id="initialGrant" min="0" step="10" placeholder="0">
                    </div>

                    <div class="input-group">
                        <label for="vestingSchedule">Vesting Schedule</label>
                        <select id="vestingSchedule"
                            style="width: 100%; padding: 10px; border: 2px solid var(--border-color); border-radius: 6px; font-size: 0.95rem; background: var(--bg-card); color: var(--text-primary);">
                            <option value="front">Front-loaded (40/30/20/10)</option>
                            <option value="even">Even (25/25/25/25)</option>
                        </select>
                    </div>

                    <div style="border-top: 1px solid #d1d5db; margin: 15px 0; padding-top: 15px;">
                        <div class="input-group" style="margin-bottom: 15px;">
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="checkbox" id="enableRefreshers" style="width: auto; margin-right: 10px; cursor: pointer;">
                                <span style="font-weight: 500;">Include Annual Refreshers</span>
                            </label>
                        </div>
                    </div>

                    <div id="refreshersInputs" style="display: none;">
                        <div class="input-group">
                            <label for="refresherYear2">Year 2 Grant (RSUs)</label>
                            <input type="number" id="refresherYear2" min="0" step="10" placeholder="0">
                        </div>

                        <div class="input-group">
                            <label for="refresherYear3">Year 3 Grant (RSUs)</label>
                            <input type="number" id="refresherYear3" min="0" step="10" placeholder="0">
                        </div>

                        <div class="input-group">
                            <label for="refresherYear4">Year 4 Grant (RSUs)</label>
                            <input type="number" id="refresherYear4" min="0" step="10" placeholder="0">
                        </div>

                        <div class="input-group">
                            <label for="refresherVesting">Refresher Vesting % (per year)</label>
                            <input type="number" id="refresherVesting" min="0" max="100" step="1" value="25">
                            <p style="font-size: 0.75rem; color: #57534e; margin-top: 5px;">% that vests in year granted
                                (typical: 25% for 4-yr vest)</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stock Prices -->
            <div class="input-section">
                <div class="section-header" onclick="toggleSection('stockPriceSection')">
                    <h2>Stock Price per Year</h2>
                    <span class="collapse-icon" id="stockPriceIcon">â–¼</span>
                </div>
                <div class="collapsible-content" id="stockPriceSection">
                    <div class="input-group">
                        <label for="stockYear1">Year 1 Stock Price ($)</label>
                        <input type="number" id="stockYear1" min="0" step="1" placeholder="0">
                    </div>

                    <div class="input-group">
                        <label for="stockGrowth">Annual Stock Growth (%)</label>
                        <input type="number" id="stockGrowth" min="-100" max="500" step="1" placeholder="0">
                        <p style="font-size: 0.75rem; color: #57534e; margin-top: 5px;">Auto-calculates Years 2-4 prices
                            (0 = no growth)</p>
                    </div>

                    <div style="border-top: 1px solid #d1d5db; margin: 15px 0; padding-top: 15px;">
                        <p style="font-size: 0.85rem; color: #57534e; margin-bottom: 10px; font-weight: 500;">Or
                            manually set each year:</p>
                    </div>

                    <div class="input-group">
                        <label for="stockYear2">Year 2 Stock Price ($)</label>
                        <input type="number" id="stockYear2" min="0" step="1" placeholder="0">
                    </div>

                    <div class="input-group">
                        <label for="stockYear3">Year 3 Stock Price ($)</label>
                        <input type="number" id="stockYear3" min="0" step="1" placeholder="0">
                    </div>

                    <div class="input-group">
                        <label for="stockYear4">Year 4 Stock Price ($)</label>
                        <input type="number" id="stockYear4" min="0" step="1" placeholder="0">
                    </div>
                </div>
            </div>

            <!-- Tax Withholding -->
            <div class="input-section">
                <div class="section-header" onclick="toggleSection('taxWithholdingSection')">
                    <h2>Tax Withholding</h2>
                    <span class="collapse-icon" id="taxWithholdingIcon">â–¼</span>
                </div>
                <div class="collapsible-content" id="taxWithholdingSection">
                    <p style="font-size: 0.85rem; color: #57534e; margin-bottom: 15px;">Optional: Calculate after-tax
                        compensation using progressive federal tax brackets</p>

                    <div class="input-group">
                        <label for="enableTax">
                            <input type="checkbox" id="enableTax" style="width: auto; margin-right: 8px;">
                            Apply tax withholding
                        </label>
                    </div>

                    <div class="input-group">
                        <label for="filingStatus">Filing Status</label>
                        <select id="filingStatus"
                            style="width: 100%; padding: 10px; border: 2px solid var(--border-color); border-radius: 6px; font-size: 0.95rem; background: var(--bg-card); color: var(--text-primary);">
                            <option value="single">Single</option>
                            <option value="married">Married Filing Jointly</option>
                            <option value="head">Head of Household</option>
                        </select>
                        <p style="font-size: 0.75rem; color: #57534e; margin-top: 5px;">Automatically applies 2026
                            standard deduction and progressive brackets</p>
                    </div>

                    <div class="input-group">
                        <label for="stateTaxRate">State Tax Rate (%)</label>
                        <input type="number" id="stateTaxRate" min="0" max="20" step="0.5" placeholder="0">
                        <p style="font-size: 0.75rem; color: #57534e; margin-top: 5px;">CA: ~9-13%, NY: ~4-11%, TX/FL:
                            0%</p>
                    </div>

                    <div class="input-group">
                        <label for="ficaTaxRate">FICA Tax (%)</label>
                        <input type="number" id="ficaTaxRate" min="0" max="20" step="0.01" value="7.65">
                        <p style="font-size: 0.75rem; color: #57534e; margin-top: 5px;">Social Security (6.2%) +
                            Medicare (1.45%) = 7.65%</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Summary Stats -->
        <div class="summary-grid">
            <div class="summary-card">
                <div class="summary-label">Year 1 Total</div>
                <div class="summary-value" id="year1Total" onclick="copyToClipboard(this)" style="cursor: pointer;" title="Click to copy">$0</div>
                <div class="summary-label" style="font-size: 0.75rem; margin-top: 5px;" id="year1TotalAfterTax"></div>
            </div>
            <div class="summary-card">
                <div class="summary-label">Year 4 Total</div>
                <div class="summary-value" id="year4Total" onclick="copyToClipboard(this)" style="cursor: pointer;" title="Click to copy">$0</div>
                <div class="summary-label" style="font-size: 0.75rem; margin-top: 5px;" id="year4TotalAfterTax"></div>
            </div>
            <div class="summary-card">
                <div class="summary-label">4-Year Total</div>
                <div class="summary-value" id="fourYearTotal" onclick="copyToClipboard(this)" style="cursor: pointer;" title="Click to copy">$0</div>
                <div class="summary-label" style="font-size: 0.75rem; margin-top: 5px;" id="fourYearTotalAfterTax">
                </div>
            </div>
            <div class="summary-card">
                <div class="summary-label">Average Annual</div>
                <div class="summary-value" id="avgAnnual" onclick="copyToClipboard(this)" style="cursor: pointer;" title="Click to copy">$0</div>
                <div class="summary-label" style="font-size: 0.75rem; margin-top: 5px;" id="avgAnnualAfterTax"></div>
            </div>
        </div>

        <!-- Stacked Bar Chart -->
        <div class="chart-container">
            <div class="section-header" onclick="toggleSection('stackedChartSection')">
                <h2>Compensation Breakdown by Year</h2>
                <span class="collapse-icon" id="stackedChartIcon">â–¼</span>
            </div>
            <div class="collapsible-content" id="stackedChartSection">
                <canvas id="stackedChart" onclick="copyChartToClipboard('stackedChart')" style="cursor: pointer;" title="Click to copy chart as image"></canvas>
            </div>
        </div>

        <!-- Line Chart -->
        <div class="chart-container">
            <div class="section-header" onclick="toggleSection('lineChartSection')">
                <h2>Total Compensation Trend</h2>
                <span class="collapse-icon" id="lineChartIcon">â–¼</span>
            </div>
            <div class="collapsible-content" id="lineChartSection">
                <canvas id="lineChart"></canvas>
            </div>
        </div>

        <!-- Detailed Table -->
        <div class="chart-container">
            <div class="section-header" onclick="toggleSection('detailedTableSection')">
                <h2>Detailed Breakdown</h2>
                <span class="collapse-icon" id="detailedTableIcon">â–¼</span>
            </div>
            <div class="collapsible-content" id="detailedTableSection">
                <div style="overflow-x: auto; -webkit-overflow-scrolling: touch;">
                    <table>
                        <thead>
                            <tr>
                                <th>Year</th>
                                <th class="text-right">Base Salary</th>
                                <th class="text-right">Bonus</th>
                                <th class="text-right">Sign-On</th>
                                <th class="text-right">Initial RSUs</th>
                                <th class="text-right">Refresher RSUs</th>
                                <th class="text-right">Stock Price</th>
                                <th class="text-right">Stock Value</th>
                                <th class="text-right"><strong>Total Comp</strong></th>
                                <th class="text-right" id="afterTaxHeader" style="display: none;"><strong>After
                                        Tax</strong></th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Levels.fyi Comparison -->
        <div class="chart-container">
            <div class="section-header" onclick="toggleSection('levelsFyiSection')">
                <h2>ðŸ“Š Compare with Market Data</h2>
                <span class="collapse-icon" id="levelsFyiIcon">â–¼</span>
            </div>
            <div class="collapsible-content" id="levelsFyiSection">
                <p style="font-size: 0.9rem; color: #57534e; margin-bottom: 15px;">
                    Use the interactive chart below to compare your compensation with market data from levels.fyi
                </p>

                <div
                    style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
                    <div>
                        <label for="levelsCompany"
                            style="display: block; font-weight: 500; margin-bottom: 8px; font-size: 0.9rem;">Company</label>
                        <select id="levelsCompany"
                            style="width: 100%; padding: 10px; border: 2px solid #d1d5db; border-radius: 6px; font-size: 0.9rem;">
                            <option value="Meta">Meta</option>
                            <option value="Google">Google</option>
                            <option value="Microsoft">Microsoft</option>
                            <option value="Amazon">Amazon</option>
                            <option value="Apple">Apple</option>
                            <option value="Netflix">Netflix</option>
                            <option value="Uber">Uber</option>
                            <option value="Lyft">Lyft</option>
                            <option value="Airbnb">Airbnb</option>
                            <option value="Dropbox">Dropbox</option>
                            <option value="Yahoo">Yahoo</option>
                            <option value="Pinterest">Pinterest</option>
                            <option value="PayPal">PayPal</option>
                            <option value="Intel">Intel</option>
                            <option value="IBM">IBM</option>
                            <option value="Salesforce">Salesforce</option>
                            <option value="Cisco">Cisco</option>
                            <option value="Workday">Workday</option>
                            <option value="LinkedIn">LinkedIn</option>
                            <option value="eBay">eBay</option>
                            <option value="Oracle">Oracle</option>
                            <option value="Intuit">Intuit</option>
                            <option value="Qualcomm">Qualcomm</option>
                            <option value="VMware">VMware</option>
                            <option value="Square">Square</option>
                            <option value="DoorDash">DoorDash</option>
                            <option value="Snap">Snap</option>
                            <option value="Comcast">Comcast</option>
                            <option value="Stripe">Stripe</option>
                            <option value="Quora">Quora</option>
                            <option value="Yelp">Yelp</option>
                            <option value="Adobe">Adobe</option>
                            <option value="Nextdoor">Nextdoor</option>
                            <option value="Spotify">Spotify</option>
                            <option value="Twitter">Twitter</option>
                            <option value="Zillow">Zillow</option>
                            <option value="Tesla">Tesla</option>
                            <option value="Groupon">Groupon</option>
                            <option value="SAP">SAP</option>
                            <option value="Indeed">Indeed</option>
                            <option value="Symantec">Symantec</option>
                            <option value="NetApp">NetApp</option>
                            <option value="Waymo">Waymo</option>
                            <option value="Nvidia">Nvidia</option>
                            <option value="AMD">AMD</option>
                            <option value="Snowflake">Snowflake</option>
                            <option value="Databricks">Databricks</option>
                            <option value="Atlassian">Atlassian</option>
                            <option value="Twilio">Twilio</option>
                            <option value="GitHub">GitHub</option>
                            <option value="GitLab">GitLab</option>
                            <option value="Asana">Asana</option>
                            <option value="Notion">Notion</option>
                            <option value="Figma">Figma</option>
                            <option value="Slack">Slack</option>
                            <option value="Zoom">Zoom</option>
                            <option value="Coinbase">Coinbase</option>
                            <option value="Robinhood">Robinhood</option>
                            <option value="Affirm">Affirm</option>
                            <option value="Shopify">Shopify</option>
                            <option value="Roblox">Roblox</option>
                            <option value="Unity">Unity</option>
                            <option value="Epic Games">Epic Games</option>
                            <option value="Reddit">Reddit</option>
                            <option value="Discord">Discord</option>
                            <option value="Instacart">Instacart</option>
                            <option value="Grubhub">Grubhub</option>
                            <option value="Expedia">Expedia</option>
                            <option value="Booking.com">Booking.com</option>
                            <option value="Box">Box</option>
                            <option value="Cloudflare">Cloudflare</option>
                            <option value="Datadog">Datadog</option>
                            <option value="Splunk">Splunk</option>
                            <option value="MongoDB">MongoDB</option>
                            <option value="Elastic">Elastic</option>
                            <option value="Palantir">Palantir</option>
                            <option value="Cruise">Cruise</option>
                            <option value="Rivian">Rivian</option>
                            <option value="Bloomberg">Bloomberg</option>
                            <option value="Citadel">Citadel</option>
                            <option value="Two Sigma">Two Sigma</option>
                            <option value="Jane Street">Jane Street</option>
                            <option value="Goldman Sachs">Goldman Sachs</option>
                            <option value="JPMorgan">JPMorgan</option>
                            <option value="Morgan Stanley">Morgan Stanley</option>
                            <option value="Palo Alto Networks">Palo Alto Networks</option>
                            <option value="Crusoe">Crusoe</option>
                            <option value="San Jose Sharks">San Jose Sharks</option>
                            <option value="Ramp">Ramp</option>
                        </select>
                    </div>

                    <div>
                        <label for="levelsTrack"
                            style="display: block; font-weight: 500; margin-bottom: 8px; font-size: 0.9rem;">Job
                            Track</label>
                        <select id="levelsTrack"
                            style="width: 100%; padding: 10px; border: 2px solid #d1d5db; border-radius: 6px; font-size: 0.9rem;">
                            <option value="Software Engineer">Software Engineer</option>
                            <option value="Product Manager">Product Manager</option>
                            <option value="Data Scientist">Data Scientist</option>
                            <option value="Machine Learning Engineer">Machine Learning Engineer</option>
                            <option value="Software Engineering Manager">Software Engineering Manager</option>
                            <option value="Product Designer">Product Designer</option>
                            <option value="Data Engineer">Data Engineer</option>
                            <option value="Technical Program Manager">Technical Program Manager</option>
                            <option value="Solutions Architect">Solutions Architect</option>
                            <option value="DevOps Engineer">DevOps Engineer</option>
                            <option value="Security Engineer">Security Engineer</option>
                            <option value="QA Engineer">QA Engineer</option>
                            <option value="Mechanical Engineer">Mechanical Engineer</option>
                            <option value="Hardware Engineer">Hardware Engineer</option>
                            <option value="Recruiter">Recruiter</option>
                            <option value="Customer Success">Customer Success</option>
                            <option value="Sales">Sales</option>
                            <option value="Marketing">Marketing</option>
                            <option value="Finance">Finance</option>
                            <option value="Legal">Legal</option>
                            <option value="General Counsel">General Counsel</option>
                            <option value="Operations">Operations</option>
                            <option value="Business Analyst">Business Analyst</option>
                            <option value="Account Manager">Account Manager</option>
                            <option value="Product Marketing Manager">Product Marketing Manager</option>
                        </select>
                    </div>
                </div>

                <iframe id="levelsIframe"
                    src="https://www.levels.fyi/charts_embed.html?company=Meta&track=Software%20Engineer&hide_selector=true"
                    height="500" style="width: 100%; border: 1px solid #e5e7eb; border-radius: 8px;" frameborder="0"
                    scrolling="auto">
                </iframe>
            </div>
        </div>

        <div class="note">
            <strong>Note:</strong> This calculator shows your initial grant vesting schedule (40/30/20/10) plus any
            refresher grants you add.
            Refresher RSUs typically vest over 4 years (25% per year by default, adjustable). The calculator assumes
            each refresher grant starts
            vesting in the year it's granted and continues vesting in subsequent years. For example, a Year 2 refresher
            will vest in Years 2, 3,
            and 4. Ask your recruiter for the specific refresher amounts and vesting schedules!
            <br><br>
            <strong>ðŸ’¾ Auto-Save:</strong> Your inputs are automatically saved in your browser and will persist when you
            refresh the page.
        </div>
        </div>
        <!-- End RSU Calculator -->

        <!-- ISO Calculator Content -->
        <div id="isoCalculator" style="display: none;">
            <div class="inputs-grid-four">
                <!-- Cash Compensation -->
                <div class="input-section">
                    <div class="section-header" onclick="toggleSection('isoCashCompSection')">
                        <h2>Cash Compensation</h2>
                        <span class="collapse-icon" id="isoCashCompIcon">â–¼</span>
                    </div>
                    <div class="collapsible-content" id="isoCashCompSection">
                        <div class="input-group">
                            <label for="isoBaseSalary">Base Salary ($)</label>
                            <input type="number" id="isoBaseSalary" min="0" step="1000" placeholder="0">
                        </div>

                        <div class="input-group">
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="checkbox" id="enableISOAnnualRaise" checked style="width: auto; margin-right: 10px; cursor: pointer;">
                                <span>Apply 3% annual raise</span>
                            </label>
                        </div>

                        <div class="input-group">
                            <label for="isoBonusPercent">Bonus (%)</label>
                            <input type="number" id="isoBonusPercent" min="0" max="200" step="1" placeholder="0">
                        </div>

                        <div class="input-group">
                            <label for="isoSignOnBonus">Sign-On Bonus ($)</label>
                            <input type="number" id="isoSignOnBonus" min="0" step="1000" placeholder="0">
                            <p style="font-size: 0.75rem; margin-top: 5px;">One-time payment in Year 1</p>
                        </div>
                    </div>
                </div>

                <!-- ISO Basics -->
                <div class="input-section">
                    <div class="section-header" onclick="toggleSection('isoBasicsSection')">
                        <h2>ISO Basics</h2>
                        <span class="collapse-icon" id="isoBasicsIcon">â–¼</span>
                    </div>
                    <div class="collapsible-content" id="isoBasicsSection">
                        <div class="input-group">
                            <label for="numberOfOptions">Number of Options</label>
                            <input type="number" id="numberOfOptions" min="0" step="100" placeholder="0">
                        </div>

                        <div class="input-group">
                            <label for="strikePrice">Strike Price ($)</label>
                            <input type="number" id="strikePrice" min="0" step="0.01" placeholder="0">
                        </div>

                        <div class="input-group">
                            <label for="assumedSharePrice">Assumed Future Share Price ($)</label>
                            <input type="number" id="assumedSharePrice" min="0" step="0.01" placeholder="0">
                        </div>
                    </div>
                </div>

                <!-- Vesting Schedule -->
                <div class="input-section">
                    <div class="section-header" onclick="toggleSection('isoVestingSection')">
                        <h2>Vesting Schedule</h2>
                        <span class="collapse-icon" id="isoVestingIcon">â–¼</span>
                    </div>
                    <div class="collapsible-content" id="isoVestingSection">
                        <div class="input-group">
                            <label for="hasCliff">1-Year Cliff</label>
                            <select id="hasCliff"
                                style="width: 100%; padding: 10px; border: 2px solid var(--border-color); border-radius: 6px; font-size: 0.95rem; background: var(--bg-card); color: var(--text-primary);">
                                <option value="yes">Yes (25% vests at 1 year)</option>
                                <option value="no">No (Monthly vesting from start)</option>
                            </select>
                        </div>

                        <div class="input-group">
                            <label for="vestingPeriod">Total Vesting Period (Years)</label>
                            <input type="number" id="vestingPeriod" min="1" max="10" step="1" value="4">
                            <p style="font-size: 0.75rem; margin-top: 5px;">Standard is 4 years</p>
                        </div>
                    </div>
                </div>

                <!-- Exercise Timing -->
                <div class="input-section">
                    <div class="section-header" onclick="toggleSection('isoExerciseSection')">
                        <h2>Exercise & Tax</h2>
                        <span class="collapse-icon" id="isoExerciseIcon">â–¼</span>
                    </div>
                    <div class="collapsible-content" id="isoExerciseSection">
                        <div class="input-group">
                            <label for="exerciseTiming">Exercise Timing</label>
                            <select id="exerciseTiming"
                                style="width: 100%; padding: 10px; border: 2px solid var(--border-color); border-radius: 6px; font-size: 0.95rem; background: var(--bg-card); color: var(--text-primary);">
                                <option value="at_vest">At Vest (as options vest)</option>
                                <option value="at_exit" selected>At Exit (all at once)</option>
                            </select>
                        </div>

                        <div class="input-group">
                            <label for="isoState">State</label>
                            <select id="isoState" onchange="updateTaxProfileOptions()"
                                style="width: 100%; padding: 10px; border: 2px solid var(--border-color); border-radius: 6px; font-size: 0.95rem; background: var(--bg-card); color: var(--text-primary);">
                                <option value="">Select state...</option>
                                <option value="CA" selected>California</option>
                                <option value="NY">New York</option>
                                <option value="TX">Texas</option>
                                <option value="FL">Florida</option>
                                <option value="WA">Washington</option>
                                <option value="MA">Massachusetts</option>
                                <option value="IL">Illinois</option>
                                <option value="PA">Pennsylvania</option>
                                <option value="CO">Colorado</option>
                                <option value="OR">Oregon</option>
                                <option value="NV">Nevada</option>
                                <option value="TN">Tennessee</option>
                                <option value="AZ">Arizona</option>
                                <option value="NC">North Carolina</option>
                                <option value="GA">Georgia</option>
                                <option value="VA">Virginia</option>
                                <option value="NJ">New Jersey</option>
                                <option value="other">Other</option>
                            </select>
                        </div>

                        <div class="input-group">
                            <label for="taxProfile">Tax Profile</label>
                            <select id="taxProfile" onchange="applyTaxProfile()"
                                style="width: 100%; padding: 10px; border: 2px solid var(--border-color); border-radius: 6px; font-size: 0.95rem; background: var(--bg-card); color: var(--text-primary);">
                                <option value="">Select a profile...</option>
                                <option value="ca_high">Single, CA high earner â†’ 40%</option>
                                <option value="ca_married">Married, CA â†’ 37%</option>
                                <option value="no_income_tax">No-income-tax state â†’ 32%</option>
                                <option value="custom">Custom â†’ unlocks manual entry</option>
                            </select>
                        </div>

                        <div class="input-group">
                            <label for="marginalTaxRate">Marginal Tax Rate  % (on ISO gains)</label>
                            <input type="number" id="marginalTaxRate" min="0" max="100" step="0.1" placeholder="37" disabled>
                            <p style="font-size: 0.75rem; margin-top: 5px;">Estimated combined federal + state rate applied to ISO gains. Not the same as tax withholding.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ISO Summary Cards -->
            <div class="summary-grid">
                <div class="summary-card">
                    <div class="summary-label">ðŸ’¸ Exercise Cost</div>
                    <div class="summary-value" id="isoExerciseCost" onclick="copyToClipboard(this)" style="cursor: pointer;" title="Click to copy">$0</div>
                </div>
                <div class="summary-card">
                    <div class="summary-label">ðŸ“ˆ Gross Upside</div>
                    <div class="summary-value" id="isoGrossUpside" onclick="copyToClipboard(this)" style="cursor: pointer;" title="Click to copy">$0</div>
                </div>
                <div class="summary-card">
                    <div class="summary-label">ðŸ§¾ Estimated Taxes</div>
                    <div class="summary-value" id="isoEstimatedTaxes" onclick="copyToClipboard(this)" style="cursor: pointer;" title="Click to copy">$0</div>
                </div>
                <div class="summary-card">
                    <div class="summary-label">âœ… Net Upside</div>
                    <div class="summary-value" id="isoNetUpside" onclick="copyToClipboard(this)" style="cursor: pointer;" title="Click to copy">$0</div>
                </div>
                <div class="summary-card">
                    <div class="summary-label">ðŸ“Š ROI Multiple</div>
                    <div class="summary-value" id="isoROI" onclick="copyToClipboard(this)" style="cursor: pointer;" title="Click to copy">0x</div>
                </div>
            </div>

            <!-- ISO Scenario Chart -->
            <div class="chart-container">
                <div class="section-header" onclick="toggleSection('isoScenarioChartSection')">
                    <h2>Compensation + ISO Upside Scenarios</h2>
                    <span class="collapse-icon" id="isoScenarioChartIcon">â–¼</span>
                </div>
                <div class="collapsible-content" id="isoScenarioChartSection">
                    <!-- Slider for scenario adjustment -->
                    <div style="margin-bottom: 20px; padding: 15px; background: var(--bg-card); border-radius: 8px; border: 1px solid var(--border-color);">
                        <label for="scenarioSharePrice" style="display: block; font-weight: 600; margin-bottom: 10px; color: var(--text-primary);">
                            Scenario Share Price: $<span id="scenarioSharePriceDisplay">0</span>
                        </label>
                        <input type="range" id="scenarioSharePrice" min="0" max="500" step="1" value="0" 
                            style="width: 100%; height: 8px; border-radius: 4px; background: var(--bg-secondary); outline: none; cursor: pointer;">
                        <div style="display: flex; justify-content: space-between; margin-top: 5px; font-size: 0.85rem; color: var(--text-secondary);">
                            <span id="sliderMinLabel">$0</span>
                            <span id="sliderMaxLabel">$500</span>
                        </div>
                    </div>
                    <canvas id="isoScenarioChart"></canvas>
                </div>
            </div>

            <div class="note">
                <strong>Note:</strong> ISO (Incentive Stock Options) calculations are estimates. Actual tax treatment depends on holding periods, AMT implications, and individual circumstances. 
                <br><br>
                <strong>Key Considerations:</strong>
                <ul style="margin-top: 10px; margin-left: 20px;">
                    <li>Exercising ISOs may trigger Alternative Minimum Tax (AMT)</li>
                    <li>Holding shares 2+ years from grant and 1+ year from exercise qualifies for favorable tax treatment</li>
                    <li>Exercise cost must be paid upfront</li>
                    <li>Consult a tax professional for personalized advice</li>
                </ul>
            </div>
        </div>
        <!-- End ISO Calculator -->

    </div>

    <script>
        // Mode switching
        let currentMode = 'rsu';

        function switchMode(mode) {
            currentMode = mode;
            
            if (mode === 'rsu') {
                document.getElementById('rsuCalculator').style.display = 'block';
                document.getElementById('isoCalculator').style.display = 'none';
                document.getElementById('rsuModeBtn').style.background = '#8feeff';
                document.getElementById('rsuModeBtn').style.color = '#0a0a0a';
                document.getElementById('isoModeBtn').style.background = 'transparent';
                document.getElementById('isoModeBtn').style.color = 'var(--text-primary)';
            } else {
                document.getElementById('rsuCalculator').style.display = 'none';
                document.getElementById('isoCalculator').style.display = 'block';
                document.getElementById('rsuModeBtn').style.background = 'transparent';
                document.getElementById('rsuModeBtn').style.color = 'var(--text-primary)';
                document.getElementById('isoModeBtn').style.background = '#8feeff';
                document.getElementById('isoModeBtn').style.color = '#0a0a0a';
                calculateISO();
            }
            
            localStorage.setItem('calculatorMode', mode);
        }

        // Tax Profile Handler
        function updateTaxProfileOptions() {
            const state = document.getElementById('isoState').value;
            const taxProfileSelect = document.getElementById('taxProfile');
            
            // State tax rate mappings (approximate marginal rates for high earners)
            const stateTaxData = {
                'CA': { name: 'California', highRate: 40, marriedRate: 37 },
                'NY': { name: 'New York', highRate: 39, marriedRate: 36 },
                'NJ': { name: 'New Jersey', highRate: 38, marriedRate: 36 },
                'OR': { name: 'Oregon', highRate: 38, marriedRate: 36 },
                'MA': { name: 'Massachusetts', highRate: 37, marriedRate: 35 },
                'IL': { name: 'Illinois', highRate: 36, marriedRate: 34 },
                'CO': { name: 'Colorado', highRate: 35, marriedRate: 33 },
                'PA': { name: 'Pennsylvania', highRate: 35, marriedRate: 33 },
                'VA': { name: 'Virginia', highRate: 36, marriedRate: 34 },
                'NC': { name: 'North Carolina', highRate: 35, marriedRate: 33 },
                'GA': { name: 'Georgia', highRate: 36, marriedRate: 34 },
                'AZ': { name: 'Arizona', highRate: 35, marriedRate: 33 },
                // No income tax states
                'TX': { name: 'Texas', highRate: 32, marriedRate: 32, noIncomeTax: true },
                'FL': { name: 'Florida', highRate: 32, marriedRate: 32, noIncomeTax: true },
                'WA': { name: 'Washington', highRate: 32, marriedRate: 32, noIncomeTax: true },
                'NV': { name: 'Nevada', highRate: 32, marriedRate: 32, noIncomeTax: true },
                'TN': { name: 'Tennessee', highRate: 32, marriedRate: 32, noIncomeTax: true }
            };
            
            // Clear existing options
            taxProfileSelect.innerHTML = '<option value="">Select a profile...</option>';
            
            if (state && stateTaxData[state]) {
                const stateData = stateTaxData[state];
                
                if (stateData.noIncomeTax) {
                    // No income tax state
                    taxProfileSelect.innerHTML += `<option value="no_tax_${state.toLowerCase()}">${stateData.name} (no state income tax) â†’ ${stateData.highRate}%</option>`;
                } else {
                    // State with income tax
                    taxProfileSelect.innerHTML += `<option value="${state.toLowerCase()}_high">Single, ${stateData.name} high earner â†’ ${stateData.highRate}%</option>`;
                    taxProfileSelect.innerHTML += `<option value="${state.toLowerCase()}_married">Married, ${stateData.name} â†’ ${stateData.marriedRate}%</option>`;
                }
            } else if (state === 'other') {
                // Generic options for other states
                taxProfileSelect.innerHTML += '<option value="other_high">High earner (est. 36%)</option>';
                taxProfileSelect.innerHTML += '<option value="other_moderate">Moderate rate (est. 34%)</option>';
            }
            
            // Always add custom option
            taxProfileSelect.innerHTML += '<option value="custom">Custom â†’ unlocks manual entry</option>';
            
            // Save state selection
            localStorage.setItem('isoState', state);
        }
        
        function applyTaxProfile() {
            const state = document.getElementById('isoState').value;
            const taxProfile = document.getElementById('taxProfile').value;
            const marginalTaxRateInput = document.getElementById('marginalTaxRate');
            
            // Build dynamic tax rates based on state
            const stateTaxData = {
                'CA': { highRate: 40, marriedRate: 37 },
                'NY': { highRate: 39, marriedRate: 36 },
                'NJ': { highRate: 38, marriedRate: 36 },
                'OR': { highRate: 38, marriedRate: 36 },
                'MA': { highRate: 37, marriedRate: 35 },
                'IL': { highRate: 36, marriedRate: 34 },
                'CO': { highRate: 35, marriedRate: 33 },
                'PA': { highRate: 35, marriedRate: 33 },
                'VA': { highRate: 36, marriedRate: 34 },
                'NC': { highRate: 35, marriedRate: 33 },
                'GA': { highRate: 36, marriedRate: 34 },
                'AZ': { highRate: 35, marriedRate: 33 },
                'TX': { highRate: 32, marriedRate: 32 },
                'FL': { highRate: 32, marriedRate: 32 },
                'WA': { highRate: 32, marriedRate: 32 },
                'NV': { highRate: 32, marriedRate: 32 },
                'TN': { highRate: 32, marriedRate: 32 }
            };
            
            let rate = null;
            
            if (taxProfile === 'custom') {
                // Enable manual entry for custom
                marginalTaxRateInput.disabled = false;
                marginalTaxRateInput.value = '';
                marginalTaxRateInput.placeholder = 'Enter custom rate';
            } else if (taxProfile === '') {
                // No profile selected
                marginalTaxRateInput.disabled = true;
                marginalTaxRateInput.value = '';
                marginalTaxRateInput.placeholder = '37';
            } else if (taxProfile === 'other_high') {
                rate = 36;
            } else if (taxProfile === 'other_moderate') {
                rate = 34;
            } else if (state && stateTaxData[state]) {
                // Dynamic rate based on state and profile
                if (taxProfile.includes('_high') || taxProfile.includes('no_tax')) {
                    rate = stateTaxData[state].highRate;
                } else if (taxProfile.includes('_married')) {
                    rate = stateTaxData[state].marriedRate;
                }
            }
            
            if (rate !== null) {
                marginalTaxRateInput.disabled = true;
                marginalTaxRateInput.value = rate;
            }
            
            // Save to localStorage
            localStorage.setItem('taxProfile', taxProfile);
            
            // Recalculate
            calculateISO();
        }

        // ISO Calculation
        function calculateISO() {
            // Cash compensation
            const isoBaseSalary = parseFloat(document.getElementById('isoBaseSalary').value) || 0;
            const isoBonusPercent = parseFloat(document.getElementById('isoBonusPercent').value) || 0;
            const isoSignOnBonus = parseFloat(document.getElementById('isoSignOnBonus').value) || 0;
            
            // ISO values
            const numberOfOptions = parseFloat(document.getElementById('numberOfOptions').value) || 0;
            const strikePrice = parseFloat(document.getElementById('strikePrice').value) || 0;
            const assumedSharePrice = parseFloat(document.getElementById('assumedSharePrice').value) || 0;
            const marginalTaxRate = parseFloat(document.getElementById('marginalTaxRate').value) / 100 || 0;

            // Cost to exercise
            const exerciseCost = strikePrice * numberOfOptions;

            // Gross upside (before tax)
            const grossUpside = (assumedSharePrice - strikePrice) * numberOfOptions;

            // Taxable spread and taxes
            const taxableSpread = grossUpside;
            const estimatedTaxes = taxableSpread * marginalTaxRate;

            // Net upside (after tax)
            const netUpside = grossUpside - estimatedTaxes;

            // ROI multiple
            const roiMultiple = exerciseCost > 0 ? (netUpside / exerciseCost) : 0;

            // Update UI
            document.getElementById('isoExerciseCost').textContent = '$' + exerciseCost.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 });
            document.getElementById('isoGrossUpside').textContent = '$' + grossUpside.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 });
            document.getElementById('isoEstimatedTaxes').textContent = '$' + estimatedTaxes.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 });
            document.getElementById('isoNetUpside').textContent = '$' + netUpside.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 });
            document.getElementById('isoROI').textContent = roiMultiple.toFixed(2) + 'x';

            // Update scenario chart
            updateISOScenarioChart();
        }

        let isoScenarioChart = null;

        // Get chart text color based on dark mode
        function getChartTextColor() {
            return document.body.classList.contains('dark-mode') ? '#e5e5e5' : '#374151';
        }

        function getChartGridColor() {
            return document.body.classList.contains('dark-mode') ? '#404040' : '#d1d5db';
        }

        function updateISOScenarioChart() {
            // Get inputs
            const isoBaseSalary = parseFloat(document.getElementById('isoBaseSalary').value) || 0;
            const isoBonusPercent = parseFloat(document.getElementById('isoBonusPercent').value) || 0;
            const isoSignOnBonus = parseFloat(document.getElementById('isoSignOnBonus').value) || 0;
            const numberOfOptions = parseFloat(document.getElementById('numberOfOptions').value) || 0;
            const strikePrice = parseFloat(document.getElementById('strikePrice').value) || 0;
            const assumedSharePrice = parseFloat(document.getElementById('assumedSharePrice').value) || 0;
            const marginalTaxRate = parseFloat(document.getElementById('marginalTaxRate').value) / 100 || 0;
            const vestingPeriod = parseFloat(document.getElementById('vestingPeriod').value) || 4;

            // Update slider display and sync
            const scenarioSlider = document.getElementById('scenarioSharePrice');
            const displayElement = document.getElementById('scenarioSharePriceDisplay');
            if (displayElement) {
                displayElement.textContent = assumedSharePrice.toFixed(2);
            }
            
            // Set intelligent slider range: from strike price to 3x assumed price (or 3x strike if no assumed)
            if (scenarioSlider && !scenarioSlider.matches(':active')) {
                const minPrice = strikePrice || 0;
                const maxPrice = assumedSharePrice > 0 
                    ? Math.max(assumedSharePrice * 3, strikePrice * 3) 
                    : (strikePrice > 0 ? strikePrice * 3 : 500);
                
                scenarioSlider.min = minPrice;
                scenarioSlider.max = maxPrice;
                scenarioSlider.value = assumedSharePrice || strikePrice;
                
                // Update labels
                document.getElementById('sliderMinLabel').textContent = '$' + minPrice.toFixed(0);
                document.getElementById('sliderMaxLabel').textContent = '$' + maxPrice.toFixed(0);
            }

            // Calculate annualized ISO upside
            const grossUpside = (assumedSharePrice - strikePrice) * numberOfOptions;
            const estimatedTaxes = grossUpside * marginalTaxRate;
            const netUpside = grossUpside - estimatedTaxes;
            const annualizedISOUpside = vestingPeriod > 0 ? netUpside / vestingPeriod : 0;

            // Calculate cash comp per year (with optional 3% raise)
            const enableISOAnnualRaise = document.getElementById('enableISOAnnualRaise').checked;
            const annualRaiseMultiplier = enableISOAnnualRaise ? 1.03 : 1;
            
            const years = [];
            for (let i = 0; i < 4; i++) {
                const currentBaseSalary = isoBaseSalary * Math.pow(annualRaiseMultiplier, i);
                const bonus = currentBaseSalary * (isoBonusPercent / 100);
                const signOn = i === 0 ? isoSignOnBonus : 0;
                const guaranteedComp = currentBaseSalary + bonus + signOn;
                const totalWithISO = guaranteedComp + annualizedISOUpside;
                
                years.push({
                    year: `Year ${i + 1}`,
                    guaranteed: guaranteedComp,
                    totalWithISO: totalWithISO
                });
            }

            // Create or update chart
            const ctx = document.getElementById('isoScenarioChart');
            if (!ctx) return;

            if (isoScenarioChart) {
                // Update existing chart data
                isoScenarioChart.data.datasets[0].data = years.map(y => y.guaranteed);
                isoScenarioChart.data.datasets[1].data = years.map(y => y.totalWithISO);
                isoScenarioChart.update('none'); // 'none' = no animation for smooth slider
            } else {
                // Create new chart
                isoScenarioChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: years.map(y => y.year),
                        datasets: [
                            {
                                label: 'Base Only (Guaranteed)',
                                data: years.map(y => y.guaranteed),
                                backgroundColor: '#8feeff',
                            },
                            {
                                label: 'Base + ISO Upside',
                                data: years.map(y => y.totalWithISO),
                                backgroundColor: '#ff630f',
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        animation: {
                            duration: 0 // Disable animation for smoother updates
                        },
                        scales: {
                            x: {
                                stacked: false,
                                ticks: {
                                    color: getChartTextColor()
                                },
                                grid: {
                                    color: getChartGridColor()
                                }
                            },
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    color: getChartTextColor(),
                                    callback: function(value) {
                                        return '$' + (value / 1000).toFixed(0) + 'k';
                                    }
                                },
                                grid: {
                                    color: getChartGridColor()
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.dataset.label + ': $' + context.parsed.y.toLocaleString();
                                    }
                                }
                            },
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    color: getChartTextColor()
                                }
                            }
                        }
                    }
                });
            }
        }

        // Add event listeners for ISO inputs
        document.addEventListener('DOMContentLoaded', function() {
            const isoInputs = ['isoBaseSalary', 'isoBonusPercent', 'isoSignOnBonus', 'numberOfOptions', 'strikePrice', 'assumedSharePrice', 'marginalTaxRate', 'vestingPeriod', 'isoState', 'enableISOAnnualRaise'];
            isoInputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', calculateISO);
                    // Save to localStorage
                    element.addEventListener('change', function() {
                        localStorage.setItem(id, this.value);
                    });
                    // Load from localStorage
                    const savedValue = localStorage.getItem(id);
                    if (savedValue) {
                        element.value = savedValue;
                    }
                }
            });

            // Add event listener for scenario share price slider
            const scenarioSlider = document.getElementById('scenarioSharePrice');
            const assumedSharePriceInput = document.getElementById('assumedSharePrice');
            
            if (scenarioSlider && assumedSharePriceInput) {
                // Slider updates assumed share price and chart
                scenarioSlider.addEventListener('input', function() {
                    assumedSharePriceInput.value = this.value;
                    document.getElementById('scenarioSharePriceDisplay').textContent = parseFloat(this.value).toFixed(2);
                    // Only update chart, not full calculation (for smoothness)
                    updateISOScenarioChart();
                });
                
                // Save to localStorage on slider release
                scenarioSlider.addEventListener('change', function() {
                    localStorage.setItem('assumedSharePrice', this.value);
                    calculateISO(); // Full recalc on release
                });
                
                // Assumed share price input updates slider and its range
                assumedSharePriceInput.addEventListener('input', function() {
                    const strikePrice = parseFloat(document.getElementById('strikePrice').value) || 0;
                    const assumedPrice = parseFloat(this.value) || 0;
                    
                    // Update slider range dynamically
                    scenarioSlider.min = strikePrice || 0;
                    scenarioSlider.max = assumedPrice > 0 
                        ? Math.max(assumedPrice * 3, strikePrice * 3) 
                        : (strikePrice > 0 ? strikePrice * 3 : 500);
                    scenarioSlider.value = this.value;
                    
                    // Update labels
                    document.getElementById('sliderMinLabel').textContent = '$' + scenarioSlider.min;
                    document.getElementById('sliderMaxLabel').textContent = '$' + Math.round(scenarioSlider.max);
                    document.getElementById('scenarioSharePriceDisplay').textContent = parseFloat(this.value || 0).toFixed(2);
                });
            }

            // Load saved state and tax profile, or use defaults
            const savedState = localStorage.getItem('isoState');
            if (savedState) {
                document.getElementById('isoState').value = savedState;
                updateTaxProfileOptions();
            } else {
                // On first load, CA is already selected by default, so update options
                updateTaxProfileOptions();
            }
            
            const savedTaxProfile = localStorage.getItem('taxProfile');
            if (savedTaxProfile) {
                document.getElementById('taxProfile').value = savedTaxProfile;
                applyTaxProfile();
            }

            // Load saved mode
            const savedMode = localStorage.getItem('calculatorMode') || 'rsu';
            switchMode(savedMode);
        });

        // Copy/Download chart as PNG
        function copyChartToClipboard(chartId) {
            const canvas = document.getElementById(chartId);
            
            // Convert canvas to blob and try clipboard API first
            canvas.toBlob(async (blob) => {
                let success = false;
                
                // Try Clipboard API (works in some browsers)
                if (navigator.clipboard && ClipboardItem) {
                    try {
                        await navigator.clipboard.write([
                            new ClipboardItem({
                                'image/png': blob
                            })
                        ]);
                        success = true;
                        showChartCopyFeedback(chartId, 'Chart copied to clipboard!');
                    } catch (err) {
                        // Clipboard API failed, fall through to download
                        console.log('Clipboard API not supported, downloading instead');
                    }
                }
                
                // Fallback: Download the image
                if (!success) {
                    const url = canvas.toDataURL('image/png');
                    const link = document.createElement('a');
                    link.download = 'compensation-breakdown.png';
                    link.href = url;
                    link.click();
                    showChartCopyFeedback(chartId, 'Chart downloaded!');
                }
            }, 'image/png');
        }

        function showChartCopyFeedback(chartId, message) {
            const canvas = document.getElementById(chartId);
            const container = canvas.parentElement;
            
            // Create feedback overlay
            const feedback = document.createElement('div');
            feedback.textContent = 'âœ“ ' + message;
            feedback.style.position = 'absolute';
            feedback.style.top = '50%';
            feedback.style.left = '50%';
            feedback.style.transform = 'translate(-50%, -50%)';
            feedback.style.background = '#10b981';
            feedback.style.color = 'white';
            feedback.style.padding = '12px 24px';
            feedback.style.borderRadius = '8px';
            feedback.style.fontSize = '1rem';
            feedback.style.fontWeight = '600';
            feedback.style.zIndex = '1000';
            feedback.style.pointerEvents = 'none';
            
            container.style.position = 'relative';
            container.appendChild(feedback);
            
            setTimeout(() => {
                feedback.remove();
            }, 2000);
        }

        // Dark mode functionality
        function initDarkMode() {
            // Check for saved preference, default to dark mode
            const savedMode = localStorage.getItem('darkMode');
            
            // If no saved preference, default to dark mode
            // If saved preference exists, use that
            if (savedMode === 'dark' || savedMode === null) {
                document.body.classList.add('dark-mode');
                updateDarkModeIcon(true);
            } else {
                updateDarkModeIcon(false);
            }
        }

        function toggleDarkMode() {
            const isDark = document.body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', isDark ? 'dark' : 'light');
            updateDarkModeIcon(isDark);
            
            // Refresh charts to update colors
            if (currentMode === 'rsu') {
                if (typeof updateDisplay === 'function') {
                    updateDisplay();
                }
            } else if (currentMode === 'iso') {
                if (typeof calculateISO === 'function') {
                    calculateISO();
                }
            }
        }

        function updateDarkModeIcon(isDark) {
            const icon = document.getElementById('darkModeIcon');
            icon.textContent = isDark ? 'â˜€ï¸' : 'ðŸŒ™';
        }

        // Initialize dark mode on page load
        initDarkMode();

        // Copy to clipboard function
        function copyToClipboard(element) {
            const text = element.textContent.trim();
            
            // Try modern clipboard API first
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => {
                    showCopyFeedback(element);
                }).catch(() => {
                    // Fallback for mobile or older browsers
                    fallbackCopy(text, element);
                });
            } else {
                // Fallback for older browsers
                fallbackCopy(text, element);
            }
        }

        function fallbackCopy(text, element) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            textarea.setSelectionRange(0, 99999); // For mobile
            
            try {
                document.execCommand('copy');
                showCopyFeedback(element);
            } catch (err) {
                console.error('Copy failed:', err);
            }
            
            document.body.removeChild(textarea);
        }

        function showCopyFeedback(element) {
            const originalText = element.textContent;
            element.textContent = 'âœ“ Copied!';
            element.style.color = '#10b981';
            
            setTimeout(() => {
                element.textContent = originalText;
                element.style.color = '';
            }, 1500);
        }

        function resetCalculator() {
            if (confirm('Are you sure you want to reset all values to defaults? This cannot be undone.')) {
                localStorage.removeItem('databricksCompCalc');
                location.reload();
            }
        }

        function getVestingSchedule() {
            const scheduleType = document.getElementById('vestingSchedule').value;
            if (scheduleType === 'front') {
                return [0.40, 0.30, 0.20, 0.10];
            } else {
                return [0.25, 0.25, 0.25, 0.25];
            }
        }

        // 2026 Federal tax brackets and standard deductions
        const taxData2026 = {
            single: {
                standardDeduction: 15000,
                brackets: [
                    { rate: 0.10, limit: 11925 },
                    { rate: 0.12, limit: 48475 },
                    { rate: 0.22, limit: 103350 },
                    { rate: 0.24, limit: 197300 },
                    { rate: 0.32, limit: 250525 },
                    { rate: 0.35, limit: 626350 },
                    { rate: 0.37, limit: Infinity }
                ]
            },
            married: {
                standardDeduction: 30000,
                brackets: [
                    { rate: 0.10, limit: 23850 },
                    { rate: 0.12, limit: 96950 },
                    { rate: 0.22, limit: 206700 },
                    { rate: 0.24, limit: 394600 },
                    { rate: 0.32, limit: 501050 },
                    { rate: 0.35, limit: 751600 },
                    { rate: 0.37, limit: Infinity }
                ]
            },
            head: {
                standardDeduction: 22500,
                brackets: [
                    { rate: 0.10, limit: 17000 },
                    { rate: 0.12, limit: 64850 },
                    { rate: 0.22, limit: 103350 },
                    { rate: 0.24, limit: 197300 },
                    { rate: 0.32, limit: 250500 },
                    { rate: 0.35, limit: 626350 },
                    { rate: 0.37, limit: Infinity }
                ]
            }
        };

        // Calculate progressive federal tax
        function calculateProgressiveFederalTax(grossIncome, filingStatus) {
            const statusData = taxData2026[filingStatus];
            const standardDeduction = statusData.standardDeduction;
            const brackets = statusData.brackets;

            // Apply standard deduction
            const taxableIncome = Math.max(0, grossIncome - standardDeduction);

            if (taxableIncome <= 0) {
                return 0;
            }

            let totalTax = 0;
            let previousLimit = 0;

            for (let i = 0; i < brackets.length; i++) {
                const bracket = brackets[i];
                const bracketLimit = bracket.limit;

                if (taxableIncome > previousLimit) {
                    const taxableInBracket = Math.min(taxableIncome, bracketLimit) - previousLimit;
                    totalTax += taxableInBracket * bracket.rate;

                    if (taxableIncome <= bracketLimit) {
                        break;
                    }
                }

                previousLimit = bracketLimit;
            }

            return totalTax;
        }

        let stackedChart, lineChart;

        // Save inputs to localStorage
        function saveInputs() {
            const inputs = [
                'baseSalary', 'bonusPercent', 'signOnBonus',
                'stockYear1', 'stockYear2', 'stockYear3', 'stockYear4', 'stockGrowth',
                'initialGrant', 'vestingSchedule', 'refresherYear2', 'refresherYear3', 'refresherYear4', 'refresherVesting',
                'filingStatus', 'stateTaxRate', 'ficaTaxRate'
            ];

            const values = {};
            inputs.forEach(id => {
                const element = document.getElementById(id);
                values[id] = element.value;
            });

            // Handle checkbox separately
            values['enableTax'] = document.getElementById('enableTax').checked;
            values['enableRefreshers'] = document.getElementById('enableRefreshers').checked;
            values['enableAnnualRaise'] = document.getElementById('enableAnnualRaise').checked;

            // Save Select2 dropdowns (company and job track)
            values['levelsCompany'] = $('#levelsCompany').val();
            values['levelsTrack'] = $('#levelsTrack').val();

            localStorage.setItem('databricksCompCalc', JSON.stringify(values));
        }

        // Load inputs from localStorage
        function loadInputs() {
            const saved = localStorage.getItem('databricksCompCalc');
            if (saved) {
                try {
                    const values = JSON.parse(saved);
                    Object.keys(values).forEach(id => {
                        const element = document.getElementById(id);
                        if (element) {
                            if (id === 'enableTax' || id === 'enableRefreshers' || id === 'enableAnnualRaise') {
                                element.checked = values[id];
                            } else {
                                element.value = values[id];
                            }
                        }
                    });

                    // Show/hide refreshers inputs based on saved state
                    const refreshersInputs = document.getElementById('refreshersInputs');
                    if (values['enableRefreshers']) {
                        refreshersInputs.style.display = 'block';
                    }

                    // Load Select2 values if they exist
                    if (values['levelsCompany']) {
                        $('#levelsCompany').val(values['levelsCompany']);
                    }
                    if (values['levelsTrack']) {
                        $('#levelsTrack').val(values['levelsTrack']);
                    }
                } catch (e) {
                    console.error('Error loading saved data:', e);
                }
            }
        }

        function formatCurrency(value) {
            return '$' + Math.round(value).toLocaleString();
        }

        function calculateComp() {
            const baseSalary = parseInt(document.getElementById('baseSalary').value) || 0;
            const bonusPercent = parseFloat(document.getElementById('bonusPercent').value) || 0;
            const signOnBonus = parseInt(document.getElementById('signOnBonus').value) || 0;
            const enableAnnualRaise = document.getElementById('enableAnnualRaise').checked;
            const annualRaise = enableAnnualRaise ? 0.03 : 0; // 3% if enabled, 0% if not

            const initialGrant = parseFloat(document.getElementById('initialGrant').value) || 0;
            const vestingSchedule = getVestingSchedule();

            const stockPrices = [
                parseFloat(document.getElementById('stockYear1').value) || 0,
                parseFloat(document.getElementById('stockYear2').value) || 0,
                parseFloat(document.getElementById('stockYear3').value) || 0,
                parseFloat(document.getElementById('stockYear4').value) || 0
            ];

            const enableRefreshers = document.getElementById('enableRefreshers').checked;
            const refresherGrants = enableRefreshers ? [
                0, // Year 1 - no refresher
                parseFloat(document.getElementById('refresherYear2').value) || 0,
                parseFloat(document.getElementById('refresherYear3').value) || 0,
                parseFloat(document.getElementById('refresherYear4').value) || 0
            ] : [0, 0, 0, 0];

            const refresherVestingPercent = enableRefreshers ? (parseFloat(document.getElementById('refresherVesting').value) / 100 || 0) : 0;

            // Tax calculation
            const enableTax = document.getElementById('enableTax').checked;
            const filingStatus = document.getElementById('filingStatus').value;
            const stateTaxRate = parseFloat(document.getElementById('stateTaxRate').value) / 100 || 0;
            const ficaTaxRate = parseFloat(document.getElementById('ficaTaxRate').value) / 100 || 0;

            const years = [];

            for (let i = 0; i < 4; i++) {
                const currentBaseSalary = baseSalary * Math.pow(1 + annualRaise, i);
                const bonus = currentBaseSalary * (bonusPercent / 100);
                // Add sign-on bonus only in Year 1
                const signOn = (i === 0) ? signOnBonus : 0;

                // Initial grant vesting
                const initialSharesVested = initialGrant * vestingSchedule[i];

                // Refresher vesting - each refresher vests over time
                let refresherSharesVested = 0;

                // Year 2: only year 2 refresher vests (first year)
                // Year 3: year 2 refresher (2nd year) + year 3 refresher (1st year)
                // Year 4: year 2 refresher (3rd year) + year 3 refresher (2nd year) + year 4 refresher (1st year)
                if (i >= 1) { // Year 2+
                    refresherSharesVested += refresherGrants[i] * refresherVestingPercent; // Current year's refresher
                }
                if (i >= 2) { // Year 3+
                    refresherSharesVested += refresherGrants[i - 1] * refresherVestingPercent; // Last year's refresher
                }
                if (i >= 3) { // Year 4
                    refresherSharesVested += refresherGrants[i - 2] * refresherVestingPercent; // 2 years ago refresher
                }

                const totalSharesVested = initialSharesVested + refresherSharesVested;
                const stockValue = totalSharesVested * stockPrices[i];
                const totalComp = currentBaseSalary + bonus + signOn + stockValue;

                // Calculate progressive taxes
                let afterTaxComp = totalComp;
                if (enableTax) {
                    const federalTax = calculateProgressiveFederalTax(totalComp, filingStatus);
                    const stateTax = totalComp * stateTaxRate;
                    const ficaTax = totalComp * ficaTaxRate;
                    const totalTax = federalTax + stateTax + ficaTax;
                    afterTaxComp = Math.round(totalComp - totalTax);
                }

                years.push({
                    year: i + 1,
                    baseSalary: Math.round(currentBaseSalary),
                    bonus: Math.round(bonus),
                    signOnBonus: Math.round(signOn),
                    initialSharesVested: Math.round(initialSharesVested),
                    refresherSharesVested: Math.round(refresherSharesVested),
                    stockPrice: stockPrices[i],
                    stockValue: Math.round(stockValue),
                    totalComp: Math.round(totalComp),
                    afterTaxComp: afterTaxComp
                });
            }

            return years;
        }

        function updateDisplay() {
            const data = calculateComp();
            const enableTax = document.getElementById('enableTax').checked;

            // Update summary cards
            document.getElementById('year1Total').textContent = formatCurrency(data[0].totalComp);
            document.getElementById('year4Total').textContent = formatCurrency(data[3].totalComp);

            const fourYearTotal = data.reduce((sum, year) => sum + year.totalComp, 0);
            document.getElementById('fourYearTotal').textContent = formatCurrency(fourYearTotal);
            document.getElementById('avgAnnual').textContent = formatCurrency(fourYearTotal / 4);

            // Show/hide after-tax values in summary cards
            if (enableTax) {
                document.getElementById('year1TotalAfterTax').textContent = 'After tax: ' + formatCurrency(data[0].afterTaxComp);
                document.getElementById('year4TotalAfterTax').textContent = 'After tax: ' + formatCurrency(data[3].afterTaxComp);
                const fourYearAfterTax = data.reduce((sum, year) => sum + year.afterTaxComp, 0);
                document.getElementById('fourYearTotalAfterTax').textContent = 'After tax: ' + formatCurrency(fourYearAfterTax);
                document.getElementById('avgAnnualAfterTax').textContent = 'After tax: ' + formatCurrency(fourYearAfterTax / 4);
            } else {
                document.getElementById('year1TotalAfterTax').textContent = '';
                document.getElementById('year4TotalAfterTax').textContent = '';
                document.getElementById('fourYearTotalAfterTax').textContent = '';
                document.getElementById('avgAnnualAfterTax').textContent = '';
            }

            // Show/hide after-tax column in table
            const afterTaxHeader = document.getElementById('afterTaxHeader');
            afterTaxHeader.style.display = enableTax ? '' : 'none';

            // Update table
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = data.map(row => `
                <tr>
                    <td>Year ${row.year}</td>
                    <td class="text-right">${formatCurrency(row.baseSalary)}</td>
                    <td class="text-right">${formatCurrency(row.bonus)}</td>
                    <td class="text-right">${row.signOnBonus > 0 ? formatCurrency(row.signOnBonus) : '-'}</td>
                    <td class="text-right">${row.initialSharesVested}</td>
                    <td class="text-right">${row.refresherSharesVested}</td>
                    <td class="text-right">$${row.stockPrice}</td>
                    <td class="text-right">${formatCurrency(row.stockValue)}</td>
                    <td class="text-right"><strong>${formatCurrency(row.totalComp)}</strong></td>
                    ${enableTax ? `<td class="text-right"><strong>${formatCurrency(row.afterTaxComp)}</strong></td>` : ''}
                </tr>
            `).join('');

            // Update charts
            updateCharts(data);
        }

        function updateCharts(data) {
            const labels = data.map(d => `Year ${d.year}`);
            const enableTax = document.getElementById('enableTax').checked;

            // Stacked Bar Chart
            if (stackedChart) stackedChart.destroy();
            const stackedCtx = document.getElementById('stackedChart').getContext('2d');

            const datasets = [
                {
                    label: 'Base Salary',
                    data: data.map(d => d.baseSalary),
                    backgroundColor: '#8feeff',
                    stack: 'pre-tax'
                },
                {
                    label: 'Bonus',
                    data: data.map(d => d.bonus),
                    backgroundColor: '#ffd700',
                    stack: 'pre-tax'
                },
                {
                    label: 'Stock Value',
                    data: data.map(d => d.stockValue),
                    backgroundColor: '#ff630f',
                    stack: 'pre-tax'
                }
            ];

            // Add after-tax bar as separate grouped bar if tax is enabled
            if (enableTax) {
                datasets.push({
                    label: 'After Tax',
                    data: data.map(d => d.afterTaxComp),
                    backgroundColor: '#a78bfa',
                    stack: 'after-tax'
                });
            }

            stackedChart = new Chart(stackedCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        x: { 
                            stacked: false,
                            ticks: {
                                color: getChartTextColor()
                            },
                            grid: {
                                color: getChartGridColor()
                            }
                        },
                        y: {
                            stacked: true,
                            ticks: {
                                color: getChartTextColor(),
                                callback: function (value) {
                                    return '$' + (value / 1000).toFixed(0) + 'k';
                                }
                            },
                            grid: {
                                color: getChartGridColor()
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return context.dataset.label + ': $' + context.parsed.y.toLocaleString();
                                }
                            }
                        },
                        legend: {
                            labels: {
                                color: getChartTextColor()
                            }
                        }
                    }
                }
            });

            // Line Chart
            if (lineChart) lineChart.destroy();
            const lineCtx = document.getElementById('lineChart').getContext('2d');

            const lineDatasets = [{
                label: 'Total Compensation',
                data: data.map(d => d.totalComp),
                borderColor: '#ff630f',
                backgroundColor: 'rgba(255, 99, 15, 0.1)',
                borderWidth: 3,
                tension: 0.4,
                fill: true
            }];

            // Add after-tax line if tax is enabled
            if (enableTax) {
                lineDatasets.push({
                    label: 'After Tax Compensation',
                    data: data.map(d => d.afterTaxComp),
                    borderColor: '#a78bfa',
                    backgroundColor: 'rgba(167, 139, 250, 0.1)',
                    borderWidth: 3,
                    borderDash: [10, 5],
                    tension: 0.4,
                    fill: true
                });
            }

            lineChart = new Chart(lineCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: lineDatasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        x: {
                            ticks: {
                                color: getChartTextColor()
                            },
                            grid: {
                                color: getChartGridColor()
                            }
                        },
                        y: {
                            ticks: {
                                color: getChartTextColor(),
                                callback: function (value) {
                                    return '$' + (value / 1000).toFixed(0) + 'k';
                                }
                            },
                            grid: {
                                color: getChartGridColor()
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return context.dataset.label + ': $' + context.parsed.y.toLocaleString();
                                }
                            }
                        },
                        legend: {
                            labels: {
                                color: getChartTextColor()
                            }
                        }
                    }
                }
            });
        }

        // Update display values as inputs change
        function setupInputListeners() {
            const inputs = [
                'baseSalary', 'bonusPercent', 'signOnBonus',
                'initialGrant', 'vestingSchedule', 'refresherYear2', 'refresherYear3', 'refresherYear4', 'refresherVesting',
                'enableTax', 'filingStatus', 'stateTaxRate', 'ficaTaxRate', 'enableRefreshers', 'enableAnnualRaise'
            ];

            inputs.forEach(id => {
                const element = document.getElementById(id);
                element.addEventListener('input', function () {
                    saveInputs();
                    updateDisplay();
                });
            });

            // Toggle refreshers inputs visibility
            const enableRefreshersCheckbox = document.getElementById('enableRefreshers');
            const refreshersInputs = document.getElementById('refreshersInputs');
            
            enableRefreshersCheckbox.addEventListener('change', function() {
                refreshersInputs.style.display = this.checked ? 'block' : 'none';
                saveInputs();
                updateDisplay();
            });

            // Special handling for stock inputs
            const stockInputs = ['stockYear1', 'stockYear2', 'stockYear3', 'stockYear4'];
            stockInputs.forEach(id => {
                const element = document.getElementById(id);
                element.addEventListener('input', function () {
                    saveInputs();
                    updateDisplay();
                });
            });

            // Special handling for stock growth - auto-calculate Years 2-4
            const stockGrowthInput = document.getElementById('stockGrowth');
            const stockYear1Input = document.getElementById('stockYear1');

            function applyStockGrowth() {
                const year1Price = parseFloat(stockYear1Input.value) || 0;
                const growthPercent = parseFloat(stockGrowthInput.value) || 0;
                const growthMultiplier = 1 + (growthPercent / 100);

                // Only auto-update if growth is not zero
                if (growthPercent !== 0) {
                    document.getElementById('stockYear2').value = Math.round(year1Price * growthMultiplier);
                    document.getElementById('stockYear3').value = Math.round(year1Price * Math.pow(growthMultiplier, 2));
                    document.getElementById('stockYear4').value = Math.round(year1Price * Math.pow(growthMultiplier, 3));
                    saveInputs();
                    updateDisplay();
                }
            }

            stockGrowthInput.addEventListener('input', function () {
                applyStockGrowth();
                saveInputs();
            });
        }

        // Toggle collapsible sections
        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            const icon = document.getElementById(sectionId.replace('Section', 'Icon'));

            section.classList.toggle('collapsed');
            icon.classList.toggle('collapsed');
        }

        // Update levels.fyi iframe based on dropdown selections
        function updateLevelsIframe() {
            const company = document.getElementById('levelsCompany').value;
            const track = document.getElementById('levelsTrack').value;
            const iframe = document.getElementById('levelsIframe');

            // URL encode the track parameter
            const encodedTrack = encodeURIComponent(track);

            iframe.src = `https://www.levels.fyi/charts_embed.html?company=${company}&track=${encodedTrack}&hide_selector=true`;
        }

        // Initialize
        loadInputs();
        setupInputListeners();

        // Initialize Select2 for searchable dropdowns
        $(document).ready(function () {
            $('#levelsCompany').select2({
                placeholder: 'Search for a company...',
                allowClear: false,
                width: '100%'
            });

            $('#levelsTrack').select2({
                placeholder: 'Search for a job track...',
                allowClear: false,
                width: '100%'
            });

            // Trigger Select2 to update with loaded values
            $('#levelsCompany').trigger('change.select2');
            $('#levelsTrack').trigger('change.select2');

            // Update iframe when Select2 dropdowns change
            $('#levelsCompany').on('change', function () {
                updateLevelsIframe();
                saveInputs(); // Save to localStorage
            });

            $('#levelsTrack').on('change', function () {
                updateLevelsIframe();
                saveInputs(); // Save to localStorage
            });
        });

        updateDisplay();
    </script>
</body>

</html>